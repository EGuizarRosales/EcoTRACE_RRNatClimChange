{
  "hash": "7b45be23ea62782d09807a5b65cd8e8a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Storm Events Data: Access & Tidying\"\nauthor: \"Emmanuel Guizar Rosales\"\ndate: \"2024-08-16\"\ndate-format: \"[last rendered on:] MMM D, YYYY\"\nformat:\n  html:\n    toc: true\n    toc-depth: 5\n    toc-expand: 2\n    number-sections: true\n    code-fold: true\n    code-summary: \"Show the code\"\neditor: visual\nexecute: \n  include: true\n  echo: true\n  message: false\n  warning: false\n  cache: true\neditor_options: \n  chunk_output_type: console\nparams:\n  currentYear: 2023\n  currentMonths: !expr month.name[1:8]\nbibliography: references_accessStormEventsData.bib\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n# install package librarian if needed\nif (!(\"librarian\" %in% rownames(installed.packages()))) {\n  install.packages(\"librarian\")\n}\n\n# load required packages\nlibrarian::shelf(\n  ropensci/rnoaa,\n  openxlsx,\n  tidyverse,\n  DT,\n  usmap\n)\n```\n:::\n\n\n\n\n# Access Data\n\n## Download Storm Events Data\n\nWe will use the [Storm Events Database](https://www.ncdc.noaa.gov/stormevents/) operated by the US National Oceanic and Atmospheric Administration. Full documentation regarding this database can be found [here](https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf). A detailed variable codebook is found [here](https://www.ncei.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Bulk-csv-Format.pdf).\n\nThere is a handy R package that allows to download different NOAA data products: [rnoaa](https://github.com/ropensci/rnoaa). We use the functions `se_files()` and `se_data`.\n\nWe first want to get a feeling for all available files:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read in meta data of available files\nse_availableFiles <- se_files()\n\n# get an overview of metadata\ncat(\"Structure of meta data:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStructure of meta data:\n```\n\n\n:::\n\n```{.r .cell-code}\nstr(se_availableFiles)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [221 Ã— 4] (S3: tbl_df/tbl/data.frame)\n $ type   : chr [1:221] \"details\" \"details\" \"details\" \"details\" ...\n $ year   : num [1:221] 1950 1951 1952 1953 1954 ...\n $ created: num [1:221] 20210803 20210803 20210803 20210803 20210803 ...\n $ url    : chr [1:221] \"https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1950_c20210803.csv.gz\" \"https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1951_c20210803.csv.gz\" \"https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1952_c20210803.csv.gz\" \"https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1953_c20210803.csv.gz\" ...\n```\n\n\n:::\n\n```{.r .cell-code}\n# display unique file types\ncat(\"\\nUnique file types:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nUnique file types:\n```\n\n\n:::\n\n```{.r .cell-code}\nunique(se_availableFiles$type)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"details\"    \"fatalities\" \"locations\"  \"legacy\"    \n```\n\n\n:::\n:::\n\n\n\n\nWe will mostly be interested in \"details\", \"locations\", and (maybe) \"fatalities\". What is the most recent data available for these files?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nse_availableFiles %>% \n  filter(year > 2020) %>% \n  arrange(desc(year)) %>% \n  select(-url) %>% \n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|type       | year|  created|\n|:----------|----:|--------:|\n|details    | 2024| 20240716|\n|fatalities | 2024| 20240716|\n|locations  | 2024| 20240716|\n|details    | 2023| 20240716|\n|fatalities | 2023| 20240716|\n|locations  | 2023| 20240716|\n|details    | 2022| 20240716|\n|fatalities | 2022| 20240716|\n|locations  | 2022| 20240716|\n|details    | 2021| 20240716|\n|fatalities | 2021| 20240716|\n|locations  | 2021| 20240716|\n\n\n:::\n:::\n\n\n\n\nNow, let's read in \"details\", \"locations\", and \"fatalities for the years 2013 up to 2023\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# define simple function (putting code in fuctions prevents workspace from being\n# clutered with variables we will not use again)\nread_in_storm_data <- function(\n    years_to_read_in = seq(params$currentYear - 10, params$currentYear, 1),\n    types_to_read_in = c(\"details\", \"locations\", \"fatalities\")\n    ) {\n  \n  # initialize data_list\n  data_list <- vector(\"list\", length = length(years_to_read_in))\n  names(data_list) <- years_to_read_in\n  for (year in seq(1, length(years_to_read_in))) {\n    data_list[[year]] <- vector(\"list\", length = length(types_to_read_in))\n    names(data_list[[year]]) <- as.character(types_to_read_in)\n  }\n  \n  # read in data over nested loop\n  for (i in seq(1,length(years_to_read_in))) {\n    for (j in seq(1,length(types_to_read_in))) {\n      currentData <- se_data(year = years_to_read_in[i], type = types_to_read_in[j])\n      data_list[[i]][[j]] <- currentData\n    }\n  }\n  \n  # save data_list\n  time <- format(Sys.time(), \"%Y%m%d\")\n  fileName <- paste0(time, \"_data_list.RDS\")\n  saveRDS(data_list, file = file.path(\"../data/stormData\", fileName))\n  # to read in data, use:\n  # data_list <- readRDS(\"../0_Data/data_list.RDS\")\n  \n  return(data_list)\n}\n\n# call function and store results in data_list\ndata_list <- read_in_storm_data()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# load most recent data_list file\nfileName <- \"data_list.RDS\"\npathName <- \"../data/stormData\"\nfilePath <- fs::dir_ls(path = pathName, regexp = paste0(fileName, \"$\")) %>% last()\ndata_list <- readRDS(filePath)\n```\n:::\n\n\n\n\n## Inspect Data Structures\n\nWhat is the structure of \"details\", \"locations\", and \"fatalities\"?\n\n### Details\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_list[[as.character(params$currentYear)]]$details %>% \n  select(-c(episode_narrative, event_narrative)) %>% \n  head(.,10) %>% \n  datatable(options = list(scrollY = \"300px\"), fillContainer = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-be524e9d34766fec829c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-be524e9d34766fec829c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"fillContainer\":true,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\"],[202310,202310,202310,202310,202310,202310,202306,202310,202310,202308],[25,25,25,25,25,25,7,1,25,6],[230,230,230,230,230,230,800,0,230,1830],[202310,202310,202310,202310,202310,202310,202306,202310,202310,202308],[27,27,27,27,27,27,14,17,27,6],[551,1437,1126,1301,600,800,1200,0,1051,1835],[186682,186682,186682,186682,186682,186682,183332,186724,186682,184619],[1145781,1145783,1145784,1145796,1145884,1145780,1120484,1145894,1145779,1130577],[\"NORTH DAKOTA\",\"NORTH DAKOTA\",\"NORTH DAKOTA\",\"NORTH DAKOTA\",\"NORTH DAKOTA\",\"NORTH DAKOTA\",\"ALASKA\",\"MINNESOTA\",\"NORTH DAKOTA\",\"ILLINOIS\"],[38,38,38,38,38,38,2,27,38,17],[2023,2023,2023,2023,2023,2023,2023,2023,2023,2023],[\"October\",\"October\",\"October\",\"October\",\"October\",\"October\",\"June\",\"October\",\"October\",\"August\"],[\"Heavy Snow\",\"Heavy Snow\",\"Heavy Snow\",\"Heavy Snow\",\"Heavy Snow\",\"Heavy Snow\",\"Flood\",\"Drought\",\"Heavy Snow\",\"Thunderstorm Wind\"],[\"Z\",\"Z\",\"Z\",\"Z\",\"Z\",\"Z\",\"C\",\"Z\",\"Z\",\"C\"],[14,24,26,28,27,7,203,23,6,49],[\"BENSON\",\"EDDY\",\"NELSON\",\"GRIGGS\",\"GRAND FORKS\",\"CAVALIER\",\"CENTRAL BEAUFORT SEA COAST\",\"SOUTH CLEARWATER\",\"TOWNER\",\"EFFINGHAM\"],[\"FGF\",\"FGF\",\"FGF\",\"FGF\",\"FGF\",\"FGF\",\"AFG\",\"FGF\",\"FGF\",\"ILX\"],[\"25-OCT-23 02:30:00\",\"25-OCT-23 02:30:00\",\"25-OCT-23 02:30:00\",\"25-OCT-23 02:30:00\",\"25-OCT-23 02:30:00\",\"25-OCT-23 02:30:00\",\"07-JUN-23 08:00:00\",\"01-OCT-23 00:00:00\",\"25-OCT-23 02:30:00\",\"06-AUG-23 18:30:00\"],[\"CST-6\",\"CST-6\",\"CST-6\",\"CST-6\",\"CST-6\",\"CST-6\",\"AKST-9\",\"CST-6\",\"CST-6\",\"CST-6\"],[\"27-OCT-23 05:51:00\",\"27-OCT-23 14:37:00\",\"27-OCT-23 11:26:00\",\"27-OCT-23 13:01:00\",\"27-OCT-23 06:00:00\",\"27-OCT-23 08:00:00\",\"14-JUN-23 12:00:00\",\"17-OCT-23 00:00:00\",\"27-OCT-23 10:51:00\",\"06-AUG-23 18:35:00\"],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[\"\",\"\",\"\",\"\",\"\",\"\",\"0.00K\",\"\",\"\",\"0.00K\"],[\"\",\"\",\"\",\"\",\"\",\"\",\"0.00K\",\"\",\"\",\"0.00K\"],[\"Public\",\"Law Enforcement\",\"Public\",\"Emergency Manager\",\"CoCoRaHS\",\"COOP Observer\",\"Department of Highways\",\"Drought Monitor\",\"Emergency Manager\",\"Trained Spotter\"],[null,null,null,null,null,null,null,null,null,52],[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"EG\"],[\"\",\"\",\"\",\"\",\"\",\"\",\"Ice Jam\",\"\",\"\",\"\"],[null,null,null,null,null,null,null,null,null,null],[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"],[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"],[null,null,null,null,null,null,null,null,null,null],[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"],[null,null,null,null,null,null,8,null,null,0],[\"\",\"\",\"\",\"\",\"\",\"\",\"SSW\",\"\",\"\",\"NW\"],[\"\",\"\",\"\",\"\",\"\",\"\",\"DEADHORSE\",\"\",\"\",\"MASON\"],[null,null,null,null,null,null,11,null,null,0],[\"\",\"\",\"\",\"\",\"\",\"\",\"SSW\",\"\",\"\",\"NW\"],[\"\",\"\",\"\",\"\",\"\",\"\",\"DEADHORSE\",\"\",\"\",\"MASON\"],[null,null,null,null,null,null,70.08580000000001,null,null,38.95],[null,null,null,null,null,null,-148.5534,null,null,-88.62],[null,null,null,null,null,null,70.0532,null,null,38.95],[null,null,null,null,null,null,-148.6153,null,null,-88.62],[\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\",\"CSV\"]],\"container\":\"<table class=\\\"display fill-container\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>begin_yearmonth<\\/th>\\n      <th>begin_day<\\/th>\\n      <th>begin_time<\\/th>\\n      <th>end_yearmonth<\\/th>\\n      <th>end_day<\\/th>\\n      <th>end_time<\\/th>\\n      <th>episode_id<\\/th>\\n      <th>event_id<\\/th>\\n      <th>state<\\/th>\\n      <th>state_fips<\\/th>\\n      <th>year<\\/th>\\n      <th>month_name<\\/th>\\n      <th>event_type<\\/th>\\n      <th>cz_type<\\/th>\\n      <th>cz_fips<\\/th>\\n      <th>cz_name<\\/th>\\n      <th>wfo<\\/th>\\n      <th>begin_date_time<\\/th>\\n      <th>cz_timezone<\\/th>\\n      <th>end_date_time<\\/th>\\n      <th>injuries_direct<\\/th>\\n      <th>injuries_indirect<\\/th>\\n      <th>deaths_direct<\\/th>\\n      <th>deaths_indirect<\\/th>\\n      <th>damage_property<\\/th>\\n      <th>damage_crops<\\/th>\\n      <th>source<\\/th>\\n      <th>magnitude<\\/th>\\n      <th>magnitude_type<\\/th>\\n      <th>flood_cause<\\/th>\\n      <th>category<\\/th>\\n      <th>tor_f_scale<\\/th>\\n      <th>tor_length<\\/th>\\n      <th>tor_width<\\/th>\\n      <th>tor_other_wfo<\\/th>\\n      <th>tor_other_cz_state<\\/th>\\n      <th>tor_other_cz_fips<\\/th>\\n      <th>tor_other_cz_name<\\/th>\\n      <th>begin_range<\\/th>\\n      <th>begin_azimuth<\\/th>\\n      <th>begin_location<\\/th>\\n      <th>end_range<\\/th>\\n      <th>end_azimuth<\\/th>\\n      <th>end_location<\\/th>\\n      <th>begin_lat<\\/th>\\n      <th>begin_lon<\\/th>\\n      <th>end_lat<\\/th>\\n      <th>end_lon<\\/th>\\n      <th>data_source<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollY\":\"300px\",\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,6,7,8,10,11,15,21,22,23,24,28,31,33,34,37,39,42,45,46,47,48]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"begin_yearmonth\",\"targets\":1},{\"name\":\"begin_day\",\"targets\":2},{\"name\":\"begin_time\",\"targets\":3},{\"name\":\"end_yearmonth\",\"targets\":4},{\"name\":\"end_day\",\"targets\":5},{\"name\":\"end_time\",\"targets\":6},{\"name\":\"episode_id\",\"targets\":7},{\"name\":\"event_id\",\"targets\":8},{\"name\":\"state\",\"targets\":9},{\"name\":\"state_fips\",\"targets\":10},{\"name\":\"year\",\"targets\":11},{\"name\":\"month_name\",\"targets\":12},{\"name\":\"event_type\",\"targets\":13},{\"name\":\"cz_type\",\"targets\":14},{\"name\":\"cz_fips\",\"targets\":15},{\"name\":\"cz_name\",\"targets\":16},{\"name\":\"wfo\",\"targets\":17},{\"name\":\"begin_date_time\",\"targets\":18},{\"name\":\"cz_timezone\",\"targets\":19},{\"name\":\"end_date_time\",\"targets\":20},{\"name\":\"injuries_direct\",\"targets\":21},{\"name\":\"injuries_indirect\",\"targets\":22},{\"name\":\"deaths_direct\",\"targets\":23},{\"name\":\"deaths_indirect\",\"targets\":24},{\"name\":\"damage_property\",\"targets\":25},{\"name\":\"damage_crops\",\"targets\":26},{\"name\":\"source\",\"targets\":27},{\"name\":\"magnitude\",\"targets\":28},{\"name\":\"magnitude_type\",\"targets\":29},{\"name\":\"flood_cause\",\"targets\":30},{\"name\":\"category\",\"targets\":31},{\"name\":\"tor_f_scale\",\"targets\":32},{\"name\":\"tor_length\",\"targets\":33},{\"name\":\"tor_width\",\"targets\":34},{\"name\":\"tor_other_wfo\",\"targets\":35},{\"name\":\"tor_other_cz_state\",\"targets\":36},{\"name\":\"tor_other_cz_fips\",\"targets\":37},{\"name\":\"tor_other_cz_name\",\"targets\":38},{\"name\":\"begin_range\",\"targets\":39},{\"name\":\"begin_azimuth\",\"targets\":40},{\"name\":\"begin_location\",\"targets\":41},{\"name\":\"end_range\",\"targets\":42},{\"name\":\"end_azimuth\",\"targets\":43},{\"name\":\"end_location\",\"targets\":44},{\"name\":\"begin_lat\",\"targets\":45},{\"name\":\"begin_lon\",\"targets\":46},{\"name\":\"end_lat\",\"targets\":47},{\"name\":\"end_lon\",\"targets\":48},{\"name\":\"data_source\",\"targets\":49}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nNote: two additional variables are not included in the table above:\n\n-   `episode_narrative` (example:) In late October, a winter storm dumped heavy snow in eastern North Dakota and northwestern Minnesota over a period of 2 days. Due to mesoscale forces at play, some areas received a foot of snow or more where the band stalled. In addition to heavy snow, there was also blowing snow, reducing visibility across the area.\n-   `event_narrative` (example:) Public reports 7.5 inches at Black Tiger Bay Campground in Saint Michael.\n\n### Locations\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_list[[as.character(params$currentYear)]]$locations %>% \n  head(.,10) %>% \n  datatable(options = list(scrollY = \"300px\"), fillContainer = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-dba85141a1572c5d6d15\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-dba85141a1572c5d6d15\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"fillContainer\":true,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\"],[202303,202303,202303,202303,202303,202303,202303,202303,202303,202303],[176742,176742,176742,176742,176742,176742,176742,176742,176742,176742],[1074014,1074015,1074016,1074017,1074018,1074019,1074020,1074021,1074022,1074023],[1,1,1,1,1,1,1,1,1,1],[2.07,1.49,1.67,0.45,2.19,0,3.41,0.89,0.5600000000000001,0.5600000000000001],[\"N\",\"SSW\",\"W\",\"ENE\",\"SSW\",\"N\",\"SSW\",\"NW\",\"W\",\"E\"],[\"ABERNATHY ARPT\",\"PROSPECT\",\"NASHVILLE\",\"GOODLETTSVILLE\",\"MILLERSVILLE\",\"GOODLETTSVILLE\",\"CORNERSVILLE\",\"JEFFERSON\",\"IVY BLUFF\",\"MONTEREY\"],[35.18,35.01,36.17,36.322,36.3394,36.32,35.3231,35.99,35.67,36.15],[-87.05,-87.01000000000001,-86.81,-86.7123,-86.70999999999999,-86.72,-86.86879999999999,-86.48,-86.06,-85.26000000000001],[3510800,35600,3610200,3619320,3620364,3619200,3519386,3559400,3540200,369000],[873000,87600,8648600,8642738,8642600,8643200,8652128,8628800,863600,8515600]],\"container\":\"<table class=\\\"display fill-container\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>yearmonth<\\/th>\\n      <th>episode_id<\\/th>\\n      <th>event_id<\\/th>\\n      <th>location_index<\\/th>\\n      <th>range<\\/th>\\n      <th>azimuth<\\/th>\\n      <th>location<\\/th>\\n      <th>latitude<\\/th>\\n      <th>longitude<\\/th>\\n      <th>lat2<\\/th>\\n      <th>lon2<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollY\":\"300px\",\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,8,9,10,11]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"yearmonth\",\"targets\":1},{\"name\":\"episode_id\",\"targets\":2},{\"name\":\"event_id\",\"targets\":3},{\"name\":\"location_index\",\"targets\":4},{\"name\":\"range\",\"targets\":5},{\"name\":\"azimuth\",\"targets\":6},{\"name\":\"location\",\"targets\":7},{\"name\":\"latitude\",\"targets\":8},{\"name\":\"longitude\",\"targets\":9},{\"name\":\"lat2\",\"targets\":10},{\"name\":\"lon2\",\"targets\":11}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n### Fatalities\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_list[[as.character(params$currentYear)]]$fatalities %>% \n  head(.,10) %>% \n  datatable(options = list(scrollY = \"300px\"), fillContainer = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-2681b1d94d390caba02c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-2681b1d94d390caba02c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"fillContainer\":true,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\"],[202307,202307,202307,202307,202307,202307,202307,202307,202307,202307],[29,29,27,28,28,24,1,1,4,19],[0,0,0,0,0,0,0,0,0,0],[49378,49359,49455,50209,50230,49305,49307,49347,49348,49358],[1108090,1108167,1109732,1128929,1131465,1104617,1106092,1106242,1106313,1107915],[\"D\",\"D\",\"D\",\"D\",\"D\",\"D\",\"D\",\"D\",\"D\",\"D\"],[\"07/29/2023 00:00:00\",\"07/29/2023 00:00:00\",\"07/27/2023 00:00:00\",\"07/28/2023 00:00:00\",\"07/28/2023 00:00:00\",\"07/24/2023 00:00:00\",\"07/01/2023 00:00:00\",\"07/01/2023 00:00:00\",\"07/04/2023 00:00:00\",\"07/19/2023 00:00:00\"],[75,44,53,52,7,48,58,42,null,1],[\"M\",\"M\",\"F\",\"F\",\"M\",\"F\",\"M\",\"M\",\"\",\"F\"],[\"Permanent Home\",\"Permanent Home\",\"Permanent Home\",\"Permanent Home\",\"In Water\",\"In Water\",\"In Water\",\"In Water\",\"In Water\",\"Vehicle/Towed Trailer\"],[202307,202307,202307,202307,202307,202307,202307,202307,202307,202307]],\"container\":\"<table class=\\\"display fill-container\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>fat_yearmonth<\\/th>\\n      <th>fat_day<\\/th>\\n      <th>fat_time<\\/th>\\n      <th>fatality_id<\\/th>\\n      <th>event_id<\\/th>\\n      <th>fatality_type<\\/th>\\n      <th>fatality_date<\\/th>\\n      <th>fatality_age<\\/th>\\n      <th>fatality_sex<\\/th>\\n      <th>fatality_location<\\/th>\\n      <th>event_yearmonth<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollY\":\"300px\",\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,8,11]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"fat_yearmonth\",\"targets\":1},{\"name\":\"fat_day\",\"targets\":2},{\"name\":\"fat_time\",\"targets\":3},{\"name\":\"fatality_id\",\"targets\":4},{\"name\":\"event_id\",\"targets\":5},{\"name\":\"fatality_type\",\"targets\":6},{\"name\":\"fatality_date\",\"targets\":7},{\"name\":\"fatality_age\",\"targets\":8},{\"name\":\"fatality_sex\",\"targets\":9},{\"name\":\"fatality_location\",\"targets\":10},{\"name\":\"event_yearmonth\",\"targets\":11}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n## Recency of Data\n\nWhat is the most recent data available in \"details\" for `params$currentYear`?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_list[[as.character(params$currentYear)]]$details %>% \n  mutate(arrange_date = strptime(end_date_time, format = \"%d-%b-%y %H:%M:%S\") %>% as_datetime()) %>% \n  arrange(desc(arrange_date)) %>% \n  .$end_date_time %>% .[1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"31-DEC-23 23:59:00\"\n```\n\n\n:::\n:::\n\n\n\n\n## Create Combined Datasets\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_details <- tibble()\nfor (i in seq(1, length(data_list))) {\n  data_details <- rbind(data_details, data_list[[i]]$details)\n}\n\ndata_locations <- tibble()\nfor (i in seq(1, length(data_list))) {\n  data_locations <- rbind(data_locations, data_list[[i]]$locations)\n}\n\ndata_fatalities <- tibble()\nfor (i in seq(1, length(data_list))) {\n  data_fatalities <- rbind(data_fatalities, data_list[[i]]$fatalities)\n}\n\n# since we will mostly work with data_details, let's save this data set\ntime <- format(Sys.time(), \"%Y%m%d\")\nfileName <- paste0(time, \"_data_details.RDS\")\nsaveRDS(data_details, file = file.path(\"../data/stormData\", fileName))\n```\n:::\n\n\n\n\n# Tidy Data\n\n## Simple Tidying\n\nWe will mainly work with `data_details`. Let's tidy up this data (convert some integers to characters, some characters to integers, and some characters to date-time format).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load most recent data_details\nfileName <- \"data_details.RDS\"\npathName <- \"../data/stormData\"\nfilePath <- fs::dir_ls(path = pathName, regexp = paste0(fileName, \"$\")) %>% last()\ndata_details <- readRDS(filePath)\n\n# convert some integers to characters so that they are not mistakenly treated\n# as integers\ntoChar <- c(\n  \"episode_id\", \"event_id\",\n  \"state_fips\", \"cz_fips\",\n  \"category\",\n  \"tor_other_cz_fips\"\n)\ndata_details <- data_details %>% \n  mutate(across(all_of(toChar), as.character))\nrm(toChar)\n\n# for damage values, we need to convert strings like\n# \"3.12M\" and \"117.00K\" to integer values. We define a function to do so:\nconvert_to_integer <- function(x) {\n  multiplier <- c(\"K\" = 1000, \"M\" = 1000000)\n  numeric_part <- as.numeric(sub(\"[^0-9.]\", \"\", x))\n  multiplier_part <- substr(x, nchar(x), nchar(x))\n  multiplier_value <- multiplier[multiplier_part]\n  return(as.integer(numeric_part * multiplier_value))\n}\n# apply function to \"damage\" variables\ndata_details <- data_details %>% \n  mutate(across(contains(\"damage\"), convert_to_integer))\nrm(convert_to_integer)\n\n# convert some character columns to date-time format\ndata_details <- data_details %>% \n  mutate(across(contains(\"date_time\"), dmy_hms))\n\n# store month_name as factor with the correct order of months as levels\ndata_details <- data_details %>% \n  mutate(month_name = factor(month_name, levels = month.name))\n\n# state_fips need to be two digits long. If the first digit was zero, this leading\n# zero was removed during the read in process of the data. This is corrected\n# using str_pad. Similarly, cz_fips needs to be three digits long.\ndata_details <- data_details %>% \n  mutate(state_fips = str_pad(state_fips, width = 2, side = \"left\", pad = \"0\")) %>% \n  mutate(cz_fips = str_pad(cz_fips, width = 3, side = \"left\", pad = \"0\"))\n```\n:::\n\n\n\n\n## FIPS Tidying\n\nFor various forms of analyses, we will need the Federal Information Processing System (FIPS) Codes for States and Counties. For instance, we will need this information to associate specific extreme weather events with certain geographical regions (mostly Counties). The package [usmap](https://github.com/pdil/usmap), which we will use to display geographical distributions of extreme weather events, works with county FIPS. Therefore, we need to tidy up our data to show events that conform to such FIPS data. The FIPS information is stored in two separate variables in the data set: `state_fips` and `cz_fips`.\n\n**Note that the storm event database assigns FIPS not only to County/Parish (`cz_type == \"C\"`), but also NWS Public Forecast Zone and Marine Zones (`cz_type == \"Z\"`).**\n\nThus, the meaning of variable `cz_fips` depends on `cz_type`. Therefore, we first need to convert Z-type FIPS to C-type FIPS. There is a [mapping](https://www.nws.noaa.gov/directives/sym/pd01005007curr.pdf) of Forecast Zones onto County FIPS we can use for this. In the following code block, we\n\n1.  create a data set `mappingData` with all the information to map NWS Forecast Zones to County FIPS and\n\n2.  use this mapping information to create a variable `county_fips` representing the County FIPS and\n\n3.  ultimately create a variable `state_county_fips` representing the full FIPS identifying each County in each State.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nFUNConvertFips <- function(myData) {\n  \n  # define vector of urls to .txt files containing the mapping information\n  urlsToFiles <- c(\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_AR.txt\",\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_CR.txt\",\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_ER.txt\",\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_PR.txt\",\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_SR.txt\",\n    \"https://www.weather.gov/source/pimar/PubRep/PUB_WR.txt\"\n  )\n  \n  # define the variable names of each column in these files\n  varNames <- c(\n    \"state_abr\",\n    \"id_zone\",\n    \"location_descr\",\n    \"county\",\n    \"fips\",\n    \"city\",\n    \"state_city_abr\"\n  )\n  \n  # define a function to read in the files\n  FUNReadFiles <- function(myURL) {\n    dataOut <- read.table(\n      file = myURL,\n      sep = \"|\",\n      header = FALSE,\n      quote = \"\",\n      colClasses = \"character\",\n      fill = FALSE\n    )\n    names(dataOut) <- varNames\n    return(dataOut)\n  }\n  \n  # \"loop\" over this function and continuously combine read in data into one data frame\n  mappingData <- plyr::ldply(urlsToFiles, FUNReadFiles) %>% \n    as_tibble()\n  \n  # create data set that maps state abbreviations to full state names\n  mapping_states_abbr <- usmap::fips_info() %>%\n    as_tibble() %>% \n    select(abbr, full) %>% \n    mutate(state = toupper(full)) %>% \n    select(-full)\n  \n  # combine mappingData with mapping_states_abbr\n  mappingData <- mappingData %>% \n    left_join(y = mapping_states_abbr, by = c(\"state_abr\" = \"abbr\")) %>% \n    relocate(state, .after = state_abr) %>% \n    mutate(cz_fips = id_zone) %>% \n    relocate(cz_fips, .after = id_zone) %>% \n    mutate(county_fips = str_extract(fips, \".{3}$\")) %>% \n    relocate(county_fips, .after = fips)\n  \n  # subset myData to myData_czTypeC and myData_czTypeZ\n  myData_czTypeC <- myData %>% \n    filter(cz_type == \"C\")\n  myData_czTypeZ <- myData %>% \n    filter(cz_type == \"Z\")\n  \n  # define county_fips in myData_czTypeC\n  myData_czTypeC <- myData_czTypeC %>% \n    mutate(county_fips = cz_fips)\n  \n  # define county_fips in myData_czTypeZ\n  # first, create a temporary dataset\n  tmp <- left_join(\n    x = myData_czTypeZ,\n    y = mappingData %>% \n      select(state, cz_fips, county_fips),\n    by = c(\"state\", \"cz_fips\"),\n    relationship = \"many-to-many\"\n  )\n  # then, create a list with meta information for myData_czTypeZ\n  myData_czTypeZ_meta <- list(\n    county_fips_isNA = tmp %>% filter(is.na(county_fips)),\n    event_id_isDoublicated = tmp %>% filter(duplicated(event_id)),\n    myData_czTypeZ_raw = tmp,\n    myData_czTypeZ_county_fips_isNA.removed = tmp %>% filter(!is.na(county_fips))\n  )\n  # define myData_czTypeZ\n  # note that we only retain events whose county_fips is not NA! To see where\n  # these NAs come from, see myData_czTypeZ_meta$county_fips_isNA\n  myData_czTypeZ <- myData_czTypeZ_meta$myData_czTypeZ_county_fips_isNA.removed\n  \n  # join myData_czTypeC and myData_czTypeZ\n  if (all(names(myData_czTypeC) == names(myData_czTypeZ))) {\n    myData_fips <- rbind(\n      myData_czTypeC,\n      myData_czTypeZ\n    )\n  } else {\n    stop(\"all(names(myData_czTypeC) == names(myData_czTypeZ)) != TRUE\")\n  }\n  \n  # create variable state_county_fips representing the full and correct fips for each county\n  myData_fips <- myData_fips %>% \n    mutate(state_county_fips = str_c(state_fips, county_fips))\n  \n  return(list(\n    myData_fips = myData_fips,\n    myData_czTypeZ_meta = myData_czTypeZ_meta\n  ))\n  \n}\n\n# call function\nout_FUNConvertFips <- FUNConvertFips(data_details)\n\n# define data_details_fips\ndata_details_fips <- out_FUNConvertFips$myData_fips\n\n# save data_details_fips\ntime <- format(Sys.time(), \"%Y%m%d\")\nfileName <- paste0(time, \"_data_details_fips_raw.RDS\")\nsaveRDS(data_details_fips, file = file.path(\"../data/stormData\", fileName))\n```\n:::\n\n\n\n\nAfter these changes, some challenges remain, which become obvious, if we try to match the FIPS provided in the data set with current FIPS available in `usmap`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load most recent data_details_fips\nfileName <- \"data_details_fips_raw.RDS\"\npathName <- \"../data/stormData\"\nfilePath <- fs::dir_ls(path = pathName, regexp = paste0(fileName, \"$\")) %>% last()\ndata_details_fips <- readRDS(filePath)\n\n# capture the warning message produced if we apply usmap::fips_info to\n# all unique state_county_fips in data_details_fips\nwarning_message <- tryCatch({\n  result <- fips_info(fips = unique(as.character(data_details_fips$state_county_fips)))\n}, warning = function(w) {\n  return(conditionMessage(w))\n})\nunmatched_fips <- str_extract_all(warning_message, \"\\\\b\\\\d{5}\\\\b\")[[1]] %>% unique()\n\n# create a tibble containing all unmatched fips\nunmatched_fips <- tibble(\n  state_county_fips = unmatched_fips,\n  state_fips = state_county_fips %>% \n    str_extract(\"^.{2}\"),\n  county_fips = state_county_fips %>% \n    str_extract(\".{3}$\")\n) %>% \n  arrange(state_county_fips)\n\n# in which states do we find unmatched fips?\nunmatched_fips_states <- unmatched_fips %>% \n  distinct(state_fips) %>% \n  left_join(\n    y = usmap::fips_info(),\n    by =c(\"state_fips\" = \"fips\")\n  )\n\n# # inspect the main land states that had unmatched fips\n# unmatched_fips_states_mainLand <- unmatched_fips_states %>% \n#   filter(!is.na(abbr))\n# plot_usmap(regions = \"counties\", include = unmatched_fips_states_mainLand$abbr[1], labels = TRUE)\n# plot_usmap(regions = \"counties\", include = unmatched_fips_states_mainLand$abbr[2], labels = TRUE)\n# unmatched_fips %>%\n#   filter(state_fips == \"02\")\n# \n# data_details_fips %>% \n#   filter(state_fips %in% (unmatched_fips_states %>% \n#            filter(is.na(abbr)) %>% \n#            pull(state_fips))) %>% \n#   select(state, cz_name) %>% \n#   distinct(state)\n```\n:::\n\n::: {#tbl-unmatchedFips .cell tbl-cap='FIPS in data_details_fips that do not match with current FIPS as provided by `usmap`.'}\n\n```{.r .cell-code}\ndatatable(unmatched_fips)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-be524e9d34766fec829c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-be524e9d34766fec829c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\",\"70\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"78\",\"79\",\"80\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"89\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"96\",\"97\",\"98\",\"99\",\"100\",\"101\",\"102\",\"103\",\"104\",\"105\",\"106\",\"107\",\"108\",\"109\",\"110\",\"111\",\"112\",\"113\",\"114\",\"115\",\"116\",\"117\",\"118\",\"119\",\"120\",\"121\",\"122\",\"123\",\"124\",\"125\",\"126\",\"127\",\"128\",\"129\",\"130\",\"131\",\"132\",\"133\",\"134\",\"135\",\"136\",\"137\",\"138\"],[\"02017\",\"02018\",\"02019\",\"02021\",\"02023\",\"02025\",\"02026\",\"02027\",\"02028\",\"02029\",\"02101\",\"02111\",\"02121\",\"02125\",\"02131\",\"02135\",\"02141\",\"02145\",\"02152\",\"02155\",\"02161\",\"02171\",\"02181\",\"02203\",\"02210\",\"02213\",\"02214\",\"02215\",\"02216\",\"02217\",\"02218\",\"02219\",\"02221\",\"02222\",\"02223\",\"02224\",\"02225\",\"02226\",\"02227\",\"02261\",\"02318\",\"02319\",\"02325\",\"02326\",\"02327\",\"09001\",\"09003\",\"09005\",\"09007\",\"09009\",\"09011\",\"09013\",\"09015\",\"96010\",\"96020\",\"96030\",\"97002\",\"97003\",\"98002\",\"98003\",\"98006\",\"99001\",\"99003\",\"99005\",\"99007\",\"99009\",\"99011\",\"99013\",\"99015\",\"99017\",\"99019\",\"99021\",\"99023\",\"99025\",\"99027\",\"99029\",\"99031\",\"99033\",\"99035\",\"99037\",\"99039\",\"99041\",\"99043\",\"99045\",\"99047\",\"99049\",\"99051\",\"99053\",\"99054\",\"99055\",\"99057\",\"99059\",\"99061\",\"99063\",\"99065\",\"99067\",\"99069\",\"99071\",\"99073\",\"99075\",\"99077\",\"99079\",\"99081\",\"99083\",\"99085\",\"99087\",\"99089\",\"99091\",\"99095\",\"99097\",\"99099\",\"99101\",\"99103\",\"99105\",\"99107\",\"99109\",\"99111\",\"99113\",\"99115\",\"99117\",\"99119\",\"99121\",\"99123\",\"99125\",\"99127\",\"99129\",\"99131\",\"99133\",\"99135\",\"99137\",\"99139\",\"99141\",\"99143\",\"99145\",\"99147\",\"99149\",\"99151\",\"99153\"],[\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"02\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"96\",\"96\",\"96\",\"97\",\"97\",\"98\",\"98\",\"98\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\",\"99\"],[\"017\",\"018\",\"019\",\"021\",\"023\",\"025\",\"026\",\"027\",\"028\",\"029\",\"101\",\"111\",\"121\",\"125\",\"131\",\"135\",\"141\",\"145\",\"152\",\"155\",\"161\",\"171\",\"181\",\"203\",\"210\",\"213\",\"214\",\"215\",\"216\",\"217\",\"218\",\"219\",\"221\",\"222\",\"223\",\"224\",\"225\",\"226\",\"227\",\"261\",\"318\",\"319\",\"325\",\"326\",\"327\",\"001\",\"003\",\"005\",\"007\",\"009\",\"011\",\"013\",\"015\",\"010\",\"020\",\"030\",\"002\",\"003\",\"002\",\"003\",\"006\",\"001\",\"003\",\"005\",\"007\",\"009\",\"011\",\"013\",\"015\",\"017\",\"019\",\"021\",\"023\",\"025\",\"027\",\"029\",\"031\",\"033\",\"035\",\"037\",\"039\",\"041\",\"043\",\"045\",\"047\",\"049\",\"051\",\"053\",\"054\",\"055\",\"057\",\"059\",\"061\",\"063\",\"065\",\"067\",\"069\",\"071\",\"073\",\"075\",\"077\",\"079\",\"081\",\"083\",\"085\",\"087\",\"089\",\"091\",\"095\",\"097\",\"099\",\"101\",\"103\",\"105\",\"107\",\"109\",\"111\",\"113\",\"115\",\"117\",\"119\",\"121\",\"123\",\"125\",\"127\",\"129\",\"131\",\"133\",\"135\",\"137\",\"139\",\"141\",\"143\",\"145\",\"147\",\"149\",\"151\",\"153\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>state_county_fips<\\/th>\\n      <th>state_fips<\\/th>\\n      <th>county_fips<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"state_county_fips\",\"targets\":1},{\"name\":\"state_fips\",\"targets\":2},{\"name\":\"county_fips\",\"targets\":3}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {#tbl-unmatchedFipsStates .cell tbl-cap='States associated with the unmatched FIPS reported in @tbl-unmatchedFips.'}\n\n```{.r .cell-code}\nknitr::kable(unmatched_fips_states)\n```\n\n::: {.cell-output-display}\n\n\n|state_fips |abbr |full        |\n|:----------|:----|:-----------|\n|02         |AK   |Alaska      |\n|09         |CT   |Connecticut |\n|96         |NA   |NA          |\n|97         |NA   |NA          |\n|98         |NA   |NA          |\n|99         |NA   |NA          |\n\n\n:::\n:::\n\n\n\n\nWhat is the origin of these unmatched FIPS? First, as listed in @tbl-terretoriesOfUS, `state_fips` 96, 97, 98, 99 are assigned to the following states that are considered territories (and not states) of the US. We will exclude these territories in further analyses.\n\n\n\n\n::: {#tbl-terretoriesOfUS .cell tbl-cap='Terretories of the US in the `data_details_fips`'}\n\n```{.r .cell-code}\ndata_details_fips %>%\n  filter(state_fips %in% (unmatched_fips_states %>%\n           filter(is.na(abbr)) %>%\n           pull(state_fips))) %>%\n  distinct(state_fips, .keep_all = TRUE) %>% \n  select(state_fips, state) %>% \n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|state_fips |state          |\n|:----------|:--------------|\n|99         |PUERTO RICO    |\n|96         |VIRGIN ISLANDS |\n|98         |GUAM           |\n|97         |AMERICAN SAMOA |\n\n\n:::\n:::\n\n\n\n\nSecond, there are many unmatched FIPS in the state of Alaska (@tbl-unmatchedFipsAlaska). This is due to the fact that Alaska had substantial changes to counties and their boundaries over the years (see [here](https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.2010.html#list-tab-957819518)). Consistent information on how to map old counties to new counties is not readily available. We will exclude Alaska from further analyses.\n\n\n\n\n::: {#tbl-unmatchedFipsAlaska .cell tbl-cap='Unmatched FIPS in the state of Alaska.'}\n\n```{.r .cell-code}\ndata_details_fips %>% \n  filter(state_county_fips %in% filter(unmatched_fips, state_fips == \"02\")$state_county_fips) %>% \n  select(state_county_fips, state, cz_name) %>% \n  distinct() %>% \n  datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-dba85141a1572c5d6d15\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-dba85141a1572c5d6d15\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\"],[\"02125\",\"02018\",\"02216\",\"02224\",\"02214\",\"02141\",\"02223\",\"02219\",\"02222\",\"02210\",\"02203\",\"02028\",\"02217\",\"02027\",\"02213\",\"02101\",\"02025\",\"02225\",\"02135\",\"02218\",\"02017\",\"02023\",\"02111\",\"02221\",\"02145\",\"02181\",\"02121\",\"02155\",\"02152\",\"02161\",\"02029\",\"02171\",\"02019\",\"02021\",\"02026\",\"02319\",\"02325\",\"02227\",\"02131\",\"02318\",\"02215\",\"02226\",\"02327\",\"02326\",\"02261\",\"02261\",\"02261\",\"02261\",\"02261\",\"02261\",\"02261\",\"02261\",\"02261\"],[\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\",\"ALASKA\"],[\"WRN P.W. SND &amp; KENAI MTNS\",\"TAIYA INLET\",\"LOWER KOYUKUK MIDDLE YKN VLYS\",\"UPR TANANA VLY FORTYMILE\",\"YUKON DELTA\",\"COPPER RIVER BASIN\",\"DELTANA AND TANANA\",\"UPPER KOYUKUK VALLEY\",\"MIDDLE TANANA VALLEY\",\"NRN &amp; INTR. SEWARD PENINSULA\",\"CENTRAL BEAUFORT SEA COAST\",\"KETCHIKAN CHANNELS\",\"UPPER KOBUK AND NOATAK VLYS\",\"CRAIG COASTAL\",\"ST LAWRENCE IS. BERING STRAIT\",\"ANCHORAGE MUNI TO BIRD CREEK\",\"JUNEAU BOROUGH\",\"DENALI\",\"SERN P.W. SND\",\"S. SLOPES OF ERN BROOKS RANGE\",\"YAKUTAT COASTAL\",\"SITKA COASTAL\",\"MATANUSKA VALLEY\",\"WRN TANANA VLY WRN YUKON VLY\",\"SUSITNA VALLEY\",\"ALASKA PENINSULA\",\"KENAI PENINSULA\",\"KUSKOKWIM DELTA\",\"LOWER KUSKOKWIM VALLEY\",\"BRISTOL BAY\",\"MISTY FJORDS\",\"KODIAK PENINSULA\",\"HAINES BOROUGH\",\"HOONAH CHANNELS\",\"WRANGELL CHANNELS\",\"HAINES BOROUGH\",\"JUNEAU BOROUGH\",\"UPPER KUSKOKWIM VALLEY\",\"NERN P.W. SND\",\"TAIYA INLET\",\"LOWER YUKON VALLEY\",\"NE. SLOPES OF THE ERN AK RNG\",\"CRAIG COASTAL\",\"WRANGELL CHANNELS\",\"NE. SLOPES OF THE ERN AK RNG\",\"NERN P.W. SND\",\"UPR TANANA VLY FORTYMILE\",\"SERN P.W. SND\",\"WRN P.W. SND &amp; KENAI MTNS\",\"COPPER RIVER BASIN\",\"Northeast Slopes of the Eastern AK Range\",\"Western Prince William Sound &amp; Kenai Mountains\",\"Northeastern Prince William Sound\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>state_county_fips<\\/th>\\n      <th>state<\\/th>\\n      <th>cz_name<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"state_county_fips\",\"targets\":1},{\"name\":\"state\",\"targets\":2},{\"name\":\"cz_name\",\"targets\":3}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n\n```{.r .cell-code}\n# # are there unmatched FIPS for Alaska in the latest year data? - YES\n# data_details_fips %>% \n#   filter(year == params$currentYear, state_fips == \"02\") %>% \n#   filter(state_county_fips %in% unmatched_fips$state_county_fips) %>% \n#   select(state_county_fips, state, cz_name)\n```\n:::\n\n\n\n\nThird, there were substantial changes in the state of Connecticut: Originally, it consisted of 8 counties. After the changes, these counties were replaced with 9 new counties (for more information, see [here](https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.2020.html#list-tab-957819518) and [here](https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut)). The old counties map to the new counties according to @tbl-connecticutNewPlanningReagions-fineGrained.\n\n\n\n\n::: {#tbl-connecticutNewPlanningReagions-fineGrained .cell tbl-cap='Connecticut exact mapping of old counties to new counties.'}\n\n```{.r .cell-code}\n# read in xlsx file mapping old counties and FIPS to new counties and FIPS\nconnecticut_newPlanningRegions <- openxlsx::read.xlsx(\n  xlsxFile = \"https://www2.census.gov/geo/docs/reference/ct_change/ct_cou_to_cousub_crosswalk.xlsx\"\n) %>% \n  as_tibble() %>% \n  select(c(1:5))\n\n# rename variable names\nnames(connecticut_newPlanningRegions) <- c(\n  \"state_fips\",\n  \"old_county_fips\",\n  \"old_county_name\",\n  \"new_county_fips\",\n  \"new_county_name\"\n)\n\n# select distinct combinations of our variables of interest\nconnecticut_newPlanningRegions <- connecticut_newPlanningRegions %>% \n  distinct(state_fips, old_county_fips, new_county_fips, .keep_all = TRUE)\n\n# combine state and county fips\nconnecticut_newPlanningRegions <- connecticut_newPlanningRegions %>% \n  mutate(state_county_fips_old = paste0(state_fips, old_county_fips),\n         state_county_fips_new = paste0(state_fips, new_county_fips))\n\n# display table\ndatatable(connecticut_newPlanningRegions)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-2681b1d94d390caba02c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-2681b1d94d390caba02c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\"],[\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"09\",\"GLOSSARY\",\"STATEFP = State FIPS Code / ANSI INCITS 38 Code\",\"COUNTYFP = County FIPS Code / ANSI INCITS 31 Code\",\"COUSUBFP = County Subdivision FIPS Code\",\"LSAD = Legal Statistical Area Descriptor Code\",\"COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS Code\",\"COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 Code\",\"FUNCSTAT = Functional Status\",\"CLASSFP = FIPS Class Code\"],[\"001\",\"001\",\"001\",\"003\",\"003\",\"003\",\"005\",\"005\",\"005\",\"007\",\"009\",\"009\",\"011\",\"011\",\"011\",\"013\",\"013\",\"015\",\"015\",null,null,null,null,null,null,null,null,null],[\"Fairfield County\",\"Fairfield County\",\"Fairfield County\",\"Hartford County\",\"Hartford County\",\"Hartford County\",\"Litchfield County\",\"Litchfield County\",\"Litchfield County\",\"Middlesex County\",\"New Haven County\",\"New Haven County\",\"New London County\",\"New London County\",\"New London County\",\"Tolland County\",\"Tolland County\",\"Windham County\",\"Windham County\",null,null,null,null,null,null,null,null,null],[\"120\",\"140\",\"190\",\"110\",\"140\",\"160\",\"140\",\"160\",\"190\",\"130\",\"140\",\"170\",\"130\",\"150\",\"180\",\"110\",\"150\",\"150\",\"180\",null,null,null,null,null,null,null,null,null],[\"Greater Bridgeport Planning Region\",\"Naugatuck Valley Planning Region\",\"Western Connecticut Planning Region\",\"Capitol Planning Region\",\"Naugatuck Valley Planning Region\",\"Northwest Hills Planning Region\",\"Naugatuck Valley Planning Region\",\"Northwest Hills Planning Region\",\"Western Connecticut Planning Region\",\"Lower Connecticut River Valley Planning Region\",\"Naugatuck Valley Planning Region\",\"South Central Connecticut Planning Region\",\"Lower Connecticut River Valley Planning Region\",\"Northeastern Connecticut Planning Region\",\"Southeastern Connecticut Planning Region\",\"Capitol Planning Region\",\"Northeastern Connecticut Planning Region\",\"Northeastern Connecticut Planning Region\",\"Southeastern Connecticut Planning Region\",null,null,null,null,null,null,null,null,null],[\"09001\",\"09001\",\"09001\",\"09003\",\"09003\",\"09003\",\"09005\",\"09005\",\"09005\",\"09007\",\"09009\",\"09009\",\"09011\",\"09011\",\"09011\",\"09013\",\"09013\",\"09015\",\"09015\",\"GLOSSARYNA\",\"STATEFP = State FIPS Code / ANSI INCITS 38 CodeNA\",\"COUNTYFP = County FIPS Code / ANSI INCITS 31 CodeNA\",\"COUSUBFP = County Subdivision FIPS CodeNA\",\"LSAD = Legal Statistical Area Descriptor CodeNA\",\"COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS CodeNA\",\"COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 CodeNA\",\"FUNCSTAT = Functional StatusNA\",\"CLASSFP = FIPS Class CodeNA\"],[\"09120\",\"09140\",\"09190\",\"09110\",\"09140\",\"09160\",\"09140\",\"09160\",\"09190\",\"09130\",\"09140\",\"09170\",\"09130\",\"09150\",\"09180\",\"09110\",\"09150\",\"09150\",\"09180\",\"GLOSSARYNA\",\"STATEFP = State FIPS Code / ANSI INCITS 38 CodeNA\",\"COUNTYFP = County FIPS Code / ANSI INCITS 31 CodeNA\",\"COUSUBFP = County Subdivision FIPS CodeNA\",\"LSAD = Legal Statistical Area Descriptor CodeNA\",\"COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS CodeNA\",\"COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 CodeNA\",\"FUNCSTAT = Functional StatusNA\",\"CLASSFP = FIPS Class CodeNA\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>state_fips<\\/th>\\n      <th>old_county_fips<\\/th>\\n      <th>old_county_name<\\/th>\\n      <th>new_county_fips<\\/th>\\n      <th>new_county_name<\\/th>\\n      <th>state_county_fips_old<\\/th>\\n      <th>state_county_fips_new<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"state_fips\",\"targets\":1},{\"name\":\"old_county_fips\",\"targets\":2},{\"name\":\"old_county_name\",\"targets\":3},{\"name\":\"new_county_fips\",\"targets\":4},{\"name\":\"new_county_name\",\"targets\":5},{\"name\":\"state_county_fips_old\",\"targets\":6},{\"name\":\"state_county_fips_new\",\"targets\":7}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nHowever, this mapping is too fine grained for our purposes. A better mapping can be achieved following @fig-connecticutOldToNewCountiesMapping, which results in the following mapping summarized in @tbl-connecticutNewPlanningReagions-lessFineGrained.\n\n![Mapping of old to new counties in Connecticut.](https://img.federalregister.gov/EN06JN22.001/EN06JN22.001_original_size.png){#fig-connecticutOldToNewCountiesMapping}\n\n\n\n\n::: {#tbl-connecticutNewPlanningReagions-lessFineGrained .cell tbl-cap='Connecticut mapping of old counties to new counties.'}\n\n```{.r .cell-code}\n# https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut\n\nold_fips <- unmatched_fips %>% \n  filter(state_fips == \"09\") %>% \n  arrange(state_county_fips) %>% \n  pull(state_county_fips)\nold_counties <- c(\n  \"Fairfield\",\n  \"Harford\",\n  \"Litchfield\",\n  \"Middlesex\",\n  \"New Haven\",\n  \"New London\",\n  \"Tolland\",\n  \"Windham\"\n)\nold <- tibble(\n  old_county = old_counties,\n  old_fips = old_fips\n)\n\nnew_counties <- c(\n  \"Greater Bridgeport Planning Region\",\n  \"Western Connecticut Planning Region\",\n  \"Capitol Planning Region\",\n  \"Northwest Hills Planning Region\",\n  \"Lower Connecticut River Valley Planning Region\",\n  \"Naugatuck Valley Planning Region\",\n  \"South Central Connecticut Planning Region\",\n  \"Southeastern Connecticut Planning Region\",\n  \"Northeastern Connecticut Planning Region\"\n)\nnew_fips <- usmap::fips(state = \"CT\", county = new_counties)\nnew <- tibble(\n  new_county = new_counties,\n  new_fips = new_fips\n)\n\nold_counties_to_new_counties <- tibble(\n  old_county = c(\n    \"Fairfield\",\n    \"Fairfield\",\n    \"Harford\",\n    \"Tolland\",\n    \"Litchfield\",\n    \"Middlesex\",\n    \"New Haven\",\n    \"New Haven\",\n    \"New London\",\n    \"Windham\"\n  ),\n  new_county = c(\n    \"Greater Bridgeport Planning Region\",\n    \"Western Connecticut Planning Region\",\n    \"Capitol Planning Region\",\n    \"Capitol Planning Region\",\n    \"Northwest Hills Planning Region\",\n    \"Lower Connecticut River Valley Planning Region\",\n    \"Naugatuck Valley Planning Region\",\n    \"South Central Connecticut Planning Region\",\n    \"Southeastern Connecticut Planning Region\",\n    \"Northeastern Connecticut Planning Region\"\n  )\n)\n\nconnecticut_newPlanningRegions <- left_join(\n  x = old_counties_to_new_counties,\n  y = old,\n  by = \"old_county\"\n) %>% \n  left_join(\n    y = new,\n    by = \"new_county\"\n  )\n\n# do some renamign and add new_county_fips\nconnecticut_newPlanningRegions <- connecticut_newPlanningRegions %>% \n  rename(\n    old_state_county_fips = old_fips,\n    new_state_county_fips = new_fips\n  ) %>% \n  mutate(new_county_fips = new_state_county_fips %>% str_extract(\".{3}$\"))\n\ndatatable(connecticut_newPlanningRegions)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-e8bfab676c78a777a7dc\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-e8bfab676c78a777a7dc\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\"],[\"Fairfield\",\"Fairfield\",\"Harford\",\"Tolland\",\"Litchfield\",\"Middlesex\",\"New Haven\",\"New Haven\",\"New London\",\"Windham\"],[\"Greater Bridgeport Planning Region\",\"Western Connecticut Planning Region\",\"Capitol Planning Region\",\"Capitol Planning Region\",\"Northwest Hills Planning Region\",\"Lower Connecticut River Valley Planning Region\",\"Naugatuck Valley Planning Region\",\"South Central Connecticut Planning Region\",\"Southeastern Connecticut Planning Region\",\"Northeastern Connecticut Planning Region\"],[\"09001\",\"09001\",\"09003\",\"09013\",\"09005\",\"09007\",\"09009\",\"09009\",\"09011\",\"09015\"],[\"09120\",\"09190\",\"09110\",\"09110\",\"09160\",\"09130\",\"09140\",\"09170\",\"09180\",\"09150\"],[\"120\",\"190\",\"110\",\"110\",\"160\",\"130\",\"140\",\"170\",\"180\",\"150\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>old_county<\\/th>\\n      <th>new_county<\\/th>\\n      <th>old_state_county_fips<\\/th>\\n      <th>new_state_county_fips<\\/th>\\n      <th>new_county_fips<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"old_county\",\"targets\":1},{\"name\":\"new_county\",\"targets\":2},{\"name\":\"old_state_county_fips\",\"targets\":3},{\"name\":\"new_state_county_fips\",\"targets\":4},{\"name\":\"new_county_fips\",\"targets\":5}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nNow we apply the changes mentioned above to `data_details_fips`:\n\n1.  remove US territories from data set\n\n2.  remove state of Alaska from data set\n\n3.  apply new county names and FIPS to the state of Connecticut\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# we apply the changes outlined in the main text in slightly changed order\n\n# first, we apply the new county names and FIPS to the state of Connecticut\n\n# We check whether all state_county_fips for Connecticut are recorded using the old\n# fips.\ntmp <- data_details_fips %>% \n  filter(state_fips == \"09\") %>% \n  filter(!state_county_fips %in% unmatched_fips$state_county_fips)\n\nif (!nrow(tmp)) {\n  message(\"All state_county_fips are recorded following the old FIPS codes.\")\n} else {\n  warning(\"There are state_county_fips that are recorded following the new FIPS codes!\")\n}\nrm(tmp)\n\n# create a data set without Connecticut entries that follow the old FIPS codes\ndata_details_fips_withoutCT <- data_details_fips %>% \n  filter(!(state_fips == \"09\" & (state_county_fips %in% unmatched_fips$state_county_fips)))\n\n# create a data set containing only Connecticut entries that follow the old FIPS codes\ndata_details_fips_CT <- data_details_fips %>% \n  filter(state_fips == \"09\" & (state_county_fips %in% unmatched_fips$state_county_fips))\n\n# mutate county_fips and state_county_fips so that they represent the new county_fips\n# and state_county_fips. Note that this will inflate the previously data_details_fips_CT\n# because there is a one-to-many relationsipt between old and new fips.\ndata_details_fips_CT <- left_join(\n    x = data_details_fips_CT,\n    y = connecticut_newPlanningRegions %>% \n      select(old_state_county_fips, new_state_county_fips, new_county_fips),\n    by = c(\"state_county_fips\" = \"old_state_county_fips\")\n  ) %>% \n  mutate(\n    county_fips = new_county_fips,\n    state_county_fips = new_state_county_fips\n  ) %>% \n  select(-starts_with(\"new_\"))\n\n# check whether the datasets without and with Connecticut have the same structure before\n# joning them again.\nif (all(names(data_details_fips_withoutCT) == names(data_details_fips_CT))) {\n  message(\"all(names(data_details_fips_withoutCT) == names(data_details_fips_CT)) == TRUE\")\n  data_details_fips <- bind_rows(\n    data_details_fips_withoutCT,\n    data_details_fips_CT\n  )\n} else {\n  warning(\"The names of data_details_fips_withoutCT and data_details_fips_CT do not matach!\")\n}\n\n# then, we remove the US territories from the data set\ndata_details_fips <- data_details_fips %>%\n  filter(!state_fips %in% (unmatched_fips_states %>%\n                             filter(is.na(abbr)) %>%\n                             pull(state_fips)))\n\n# finally, we remove the state of Alaska (FIPS = 02) from the data set, but we save\n# a data set still containing Alaska just in case...\ndata_details_fips_withAK <- data_details_fips\n\ndata_details_fips <- data_details_fips %>%\n  filter(state_fips != \"02\")\n```\n:::\n\n\n\n\nFinally, we rearrange some variables in `data_details_fips` and save them for later use. We also store `state_fips`, `state_county_fips` and `event_type` as factors. This becomes handy for accurately counting number of events by groups later on.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# rearrange order of variables in the data set\ndata_details_fips <- data_details_fips %>% \n  select(\n    begin_yearmonth,\n    episode_id, event_id,\n    state, state_county_fips,\n    event_type,\n    starts_with(\"damage\"),\n    starts_with(\"injuries\"),\n    starts_with(\"death\"),\n    everything()\n  ) %>% \n  arrange(begin_yearmonth, episode_id, event_id, state_county_fips)\n\n# store state_county_fips and event_type as factor\ndata_details_fips <- data_details_fips %>% \n  mutate(\n    state_fips = factor(state_fips, levels = sort(unique(.$state_fips))),\n    state_county_fips = factor(state_county_fips, levels = sort(unique(.$state_county_fips))),\n    event_type = factor(event_type, levels = sort(unique(.$event_type)))\n  )\n\n# save data_details_fips\ntime <- format(Sys.time(), \"%Y%m%d\")\nfileName <- paste0(time, \"_data_details_fips.RDS\")\nsaveRDS(data_details_fips, file = file.path(\"../data/stormData\", fileName))\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}