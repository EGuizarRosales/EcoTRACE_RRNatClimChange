<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emmanuel Guizar Rosales">

<title>Storm Events Data: Access &amp; Tidying – EcoTRACE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.33/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">EcoTRACE</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-preprocessing-storm-events" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Preprocessing Storm Events</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-preprocessing-storm-events">    
        <li>
    <a class="dropdown-item" href="../scripts/accessStormEventsData.html">
 <span class="dropdown-text">Access &amp; Tidy Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../scripts/analyseStormEventsData.html">
 <span class="dropdown-text">Analyse Data</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../scripts/powerSimulations.html"> 
<span class="menu-text">Power Analyses</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#access-data" id="toc-access-data" class="nav-link active" data-scroll-target="#access-data"><span class="header-section-number">1</span> Access Data</a>
  <ul>
  <li><a href="#download-storm-events-data" id="toc-download-storm-events-data" class="nav-link" data-scroll-target="#download-storm-events-data"><span class="header-section-number">1.1</span> Download Storm Events Data</a></li>
  <li><a href="#inspect-data-structures" id="toc-inspect-data-structures" class="nav-link" data-scroll-target="#inspect-data-structures"><span class="header-section-number">1.2</span> Inspect Data Structures</a>
  <ul>
  <li><a href="#details" id="toc-details" class="nav-link" data-scroll-target="#details"><span class="header-section-number">1.2.1</span> Details</a></li>
  <li><a href="#locations" id="toc-locations" class="nav-link" data-scroll-target="#locations"><span class="header-section-number">1.2.2</span> Locations</a></li>
  <li><a href="#fatalities" id="toc-fatalities" class="nav-link" data-scroll-target="#fatalities"><span class="header-section-number">1.2.3</span> Fatalities</a></li>
  </ul></li>
  <li><a href="#recency-of-data" id="toc-recency-of-data" class="nav-link" data-scroll-target="#recency-of-data"><span class="header-section-number">1.3</span> Recency of Data</a></li>
  <li><a href="#create-combined-datasets" id="toc-create-combined-datasets" class="nav-link" data-scroll-target="#create-combined-datasets"><span class="header-section-number">1.4</span> Create Combined Datasets</a></li>
  </ul></li>
  <li><a href="#tidy-data" id="toc-tidy-data" class="nav-link" data-scroll-target="#tidy-data"><span class="header-section-number">2</span> Tidy Data</a>
  <ul>
  <li><a href="#simple-tidying" id="toc-simple-tidying" class="nav-link" data-scroll-target="#simple-tidying"><span class="header-section-number">2.1</span> Simple Tidying</a></li>
  <li><a href="#fips-tidying" id="toc-fips-tidying" class="nav-link" data-scroll-target="#fips-tidying"><span class="header-section-number">2.2</span> FIPS Tidying</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Storm Events Data: Access &amp; Tidying</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emmanuel Guizar Rosales </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">last rendered on: Aug 16, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install package librarian if needed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"librarian"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"librarian"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load required packages</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ropensci<span class="sc">/</span>rnoaa,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  openxlsx,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  tidyverse,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  DT,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  usmap</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="access-data" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Access Data</h1>
<section id="download-storm-events-data" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="download-storm-events-data"><span class="header-section-number">1.1</span> Download Storm Events Data</h2>
<p>We will use the <a href="https://www.ncdc.noaa.gov/stormevents/">Storm Events Database</a> operated by the US National Oceanic and Atmospheric Administration. Full documentation regarding this database can be found <a href="https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf">here</a>. A detailed variable codebook is found <a href="https://www.ncei.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Bulk-csv-Format.pdf">here</a>.</p>
<p>There is a handy R package that allows to download different NOAA data products: <a href="https://github.com/ropensci/rnoaa">rnoaa</a>. We use the functions <code>se_files()</code> and <code>se_data</code>.</p>
<p>We first want to get a feeling for all available files:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in meta data of available files</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>se_availableFiles <span class="ot">&lt;-</span> <span class="fu">se_files</span>()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get an overview of metadata</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Structure of meta data:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Structure of meta data:</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(se_availableFiles)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [221 × 4] (S3: tbl_df/tbl/data.frame)
 $ type   : chr [1:221] "details" "details" "details" "details" ...
 $ year   : num [1:221] 1950 1951 1952 1953 1954 ...
 $ created: num [1:221] 20210803 20210803 20210803 20210803 20210803 ...
 $ url    : chr [1:221] "https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1950_c20210803.csv.gz" "https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1951_c20210803.csv.gz" "https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1952_c20210803.csv.gz" "https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d1953_c20210803.csv.gz" ...</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display unique file types</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Unique file types:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Unique file types:</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(se_availableFiles<span class="sc">$</span>type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "details"    "fatalities" "locations"  "legacy"    </code></pre>
</div>
</div>
<p>We will mostly be interested in “details”, “locations”, and (maybe) “fatalities”. What is the most recent data available for these files?</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>se_availableFiles <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">2020</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(year)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>url) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">type</th>
<th style="text-align: right;">year</th>
<th style="text-align: right;">created</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">details</td>
<td style="text-align: right;">2024</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">fatalities</td>
<td style="text-align: right;">2024</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">locations</td>
<td style="text-align: right;">2024</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">details</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fatalities</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">locations</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">details</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">fatalities</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">locations</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">details</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fatalities</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">20240716</td>
</tr>
<tr class="even">
<td style="text-align: left;">locations</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">20240716</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now, let’s read in “details”, “locations”, and “fatalities for the years 2013 up to 2023</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define simple function (putting code in fuctions prevents workspace from being</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># clutered with variables we will not use again)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>read_in_storm_data <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_to_read_in =</span> <span class="fu">seq</span>(params<span class="sc">$</span>currentYear <span class="sc">-</span> <span class="dv">10</span>, params<span class="sc">$</span>currentYear, <span class="dv">1</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">types_to_read_in =</span> <span class="fu">c</span>(<span class="st">"details"</span>, <span class="st">"locations"</span>, <span class="st">"fatalities"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    ) {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize data_list</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  data_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(years_to_read_in))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data_list) <span class="ot">&lt;-</span> years_to_read_in</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (year <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(years_to_read_in))) {</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    data_list[[year]] <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(types_to_read_in))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(data_list[[year]]) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(types_to_read_in)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read in data over nested loop</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="fu">length</span>(years_to_read_in))) {</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="fu">length</span>(types_to_read_in))) {</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      currentData <span class="ot">&lt;-</span> <span class="fu">se_data</span>(<span class="at">year =</span> years_to_read_in[i], <span class="at">type =</span> types_to_read_in[j])</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      data_list[[i]][[j]] <span class="ot">&lt;-</span> currentData</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save data_list</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  fileName <span class="ot">&lt;-</span> <span class="fu">paste0</span>(time, <span class="st">"_data_list.RDS"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(data_list, <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">"../data/stormData"</span>, fileName))</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to read in data, use:</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data_list &lt;- readRDS("../0_Data/data_list.RDS")</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_list)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co"># call function and store results in data_list</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">read_in_storm_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load most recent data_list file</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="st">"data_list.RDS"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>pathName <span class="ot">&lt;-</span> <span class="st">"../data/stormData"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>filePath <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(<span class="at">path =</span> pathName, <span class="at">regexp =</span> <span class="fu">paste0</span>(fileName, <span class="st">"$"</span>)) <span class="sc">%&gt;%</span> <span class="fu">last</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filePath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inspect-data-structures" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="inspect-data-structures"><span class="header-section-number">1.2</span> Inspect Data Structures</h2>
<p>What is the structure of “details”, “locations”, and “fatalities”?</p>
<section id="details" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="details"><span class="header-section-number">1.2.1</span> Details</h3>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data_list[[<span class="fu">as.character</span>(params<span class="sc">$</span>currentYear)]]<span class="sc">$</span>details <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(episode_narrative, event_narrative)) <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(.,<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollY =</span> <span class="st">"300px"</span>), <span class="at">fillContainer =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-be524e9d34766fec829c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-be524e9d34766fec829c">{"x":{"filter":"none","vertical":false,"fillContainer":true,"data":[["1","2","3","4","5","6","7","8","9","10"],[202310,202310,202310,202310,202310,202310,202306,202310,202310,202308],[25,25,25,25,25,25,7,1,25,6],[230,230,230,230,230,230,800,0,230,1830],[202310,202310,202310,202310,202310,202310,202306,202310,202310,202308],[27,27,27,27,27,27,14,17,27,6],[551,1437,1126,1301,600,800,1200,0,1051,1835],[186682,186682,186682,186682,186682,186682,183332,186724,186682,184619],[1145781,1145783,1145784,1145796,1145884,1145780,1120484,1145894,1145779,1130577],["NORTH DAKOTA","NORTH DAKOTA","NORTH DAKOTA","NORTH DAKOTA","NORTH DAKOTA","NORTH DAKOTA","ALASKA","MINNESOTA","NORTH DAKOTA","ILLINOIS"],[38,38,38,38,38,38,2,27,38,17],[2023,2023,2023,2023,2023,2023,2023,2023,2023,2023],["October","October","October","October","October","October","June","October","October","August"],["Heavy Snow","Heavy Snow","Heavy Snow","Heavy Snow","Heavy Snow","Heavy Snow","Flood","Drought","Heavy Snow","Thunderstorm Wind"],["Z","Z","Z","Z","Z","Z","C","Z","Z","C"],[14,24,26,28,27,7,203,23,6,49],["BENSON","EDDY","NELSON","GRIGGS","GRAND FORKS","CAVALIER","CENTRAL BEAUFORT SEA COAST","SOUTH CLEARWATER","TOWNER","EFFINGHAM"],["FGF","FGF","FGF","FGF","FGF","FGF","AFG","FGF","FGF","ILX"],["25-OCT-23 02:30:00","25-OCT-23 02:30:00","25-OCT-23 02:30:00","25-OCT-23 02:30:00","25-OCT-23 02:30:00","25-OCT-23 02:30:00","07-JUN-23 08:00:00","01-OCT-23 00:00:00","25-OCT-23 02:30:00","06-AUG-23 18:30:00"],["CST-6","CST-6","CST-6","CST-6","CST-6","CST-6","AKST-9","CST-6","CST-6","CST-6"],["27-OCT-23 05:51:00","27-OCT-23 14:37:00","27-OCT-23 11:26:00","27-OCT-23 13:01:00","27-OCT-23 06:00:00","27-OCT-23 08:00:00","14-JUN-23 12:00:00","17-OCT-23 00:00:00","27-OCT-23 10:51:00","06-AUG-23 18:35:00"],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],["","","","","","","0.00K","","","0.00K"],["","","","","","","0.00K","","","0.00K"],["Public","Law Enforcement","Public","Emergency Manager","CoCoRaHS","COOP Observer","Department of Highways","Drought Monitor","Emergency Manager","Trained Spotter"],[null,null,null,null,null,null,null,null,null,52],["","","","","","","","","","EG"],["","","","","","","Ice Jam","","",""],[null,null,null,null,null,null,null,null,null,null],["","","","","","","","","",""],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["","","","","","","","","",""],["","","","","","","","","",""],[null,null,null,null,null,null,null,null,null,null],["","","","","","","","","",""],[null,null,null,null,null,null,8,null,null,0],["","","","","","","SSW","","","NW"],["","","","","","","DEADHORSE","","","MASON"],[null,null,null,null,null,null,11,null,null,0],["","","","","","","SSW","","","NW"],["","","","","","","DEADHORSE","","","MASON"],[null,null,null,null,null,null,70.08580000000001,null,null,38.95],[null,null,null,null,null,null,-148.5534,null,null,-88.62],[null,null,null,null,null,null,70.0532,null,null,38.95],[null,null,null,null,null,null,-148.6153,null,null,-88.62],["CSV","CSV","CSV","CSV","CSV","CSV","CSV","CSV","CSV","CSV"]],"container":"<table class=\"display fill-container\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>begin_yearmonth<\/th>\n      <th>begin_day<\/th>\n      <th>begin_time<\/th>\n      <th>end_yearmonth<\/th>\n      <th>end_day<\/th>\n      <th>end_time<\/th>\n      <th>episode_id<\/th>\n      <th>event_id<\/th>\n      <th>state<\/th>\n      <th>state_fips<\/th>\n      <th>year<\/th>\n      <th>month_name<\/th>\n      <th>event_type<\/th>\n      <th>cz_type<\/th>\n      <th>cz_fips<\/th>\n      <th>cz_name<\/th>\n      <th>wfo<\/th>\n      <th>begin_date_time<\/th>\n      <th>cz_timezone<\/th>\n      <th>end_date_time<\/th>\n      <th>injuries_direct<\/th>\n      <th>injuries_indirect<\/th>\n      <th>deaths_direct<\/th>\n      <th>deaths_indirect<\/th>\n      <th>damage_property<\/th>\n      <th>damage_crops<\/th>\n      <th>source<\/th>\n      <th>magnitude<\/th>\n      <th>magnitude_type<\/th>\n      <th>flood_cause<\/th>\n      <th>category<\/th>\n      <th>tor_f_scale<\/th>\n      <th>tor_length<\/th>\n      <th>tor_width<\/th>\n      <th>tor_other_wfo<\/th>\n      <th>tor_other_cz_state<\/th>\n      <th>tor_other_cz_fips<\/th>\n      <th>tor_other_cz_name<\/th>\n      <th>begin_range<\/th>\n      <th>begin_azimuth<\/th>\n      <th>begin_location<\/th>\n      <th>end_range<\/th>\n      <th>end_azimuth<\/th>\n      <th>end_location<\/th>\n      <th>begin_lat<\/th>\n      <th>begin_lon<\/th>\n      <th>end_lat<\/th>\n      <th>end_lon<\/th>\n      <th>data_source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollY":"300px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,10,11,15,21,22,23,24,28,31,33,34,37,39,42,45,46,47,48]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"begin_yearmonth","targets":1},{"name":"begin_day","targets":2},{"name":"begin_time","targets":3},{"name":"end_yearmonth","targets":4},{"name":"end_day","targets":5},{"name":"end_time","targets":6},{"name":"episode_id","targets":7},{"name":"event_id","targets":8},{"name":"state","targets":9},{"name":"state_fips","targets":10},{"name":"year","targets":11},{"name":"month_name","targets":12},{"name":"event_type","targets":13},{"name":"cz_type","targets":14},{"name":"cz_fips","targets":15},{"name":"cz_name","targets":16},{"name":"wfo","targets":17},{"name":"begin_date_time","targets":18},{"name":"cz_timezone","targets":19},{"name":"end_date_time","targets":20},{"name":"injuries_direct","targets":21},{"name":"injuries_indirect","targets":22},{"name":"deaths_direct","targets":23},{"name":"deaths_indirect","targets":24},{"name":"damage_property","targets":25},{"name":"damage_crops","targets":26},{"name":"source","targets":27},{"name":"magnitude","targets":28},{"name":"magnitude_type","targets":29},{"name":"flood_cause","targets":30},{"name":"category","targets":31},{"name":"tor_f_scale","targets":32},{"name":"tor_length","targets":33},{"name":"tor_width","targets":34},{"name":"tor_other_wfo","targets":35},{"name":"tor_other_cz_state","targets":36},{"name":"tor_other_cz_fips","targets":37},{"name":"tor_other_cz_name","targets":38},{"name":"begin_range","targets":39},{"name":"begin_azimuth","targets":40},{"name":"begin_location","targets":41},{"name":"end_range","targets":42},{"name":"end_azimuth","targets":43},{"name":"end_location","targets":44},{"name":"begin_lat","targets":45},{"name":"begin_lon","targets":46},{"name":"end_lat","targets":47},{"name":"end_lon","targets":48},{"name":"data_source","targets":49}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Note: two additional variables are not included in the table above:</p>
<ul>
<li><code>episode_narrative</code> (example:) In late October, a winter storm dumped heavy snow in eastern North Dakota and northwestern Minnesota over a period of 2 days. Due to mesoscale forces at play, some areas received a foot of snow or more where the band stalled. In addition to heavy snow, there was also blowing snow, reducing visibility across the area.</li>
<li><code>event_narrative</code> (example:) Public reports 7.5 inches at Black Tiger Bay Campground in Saint Michael.</li>
</ul>
</section>
<section id="locations" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="locations"><span class="header-section-number">1.2.2</span> Locations</h3>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_list[[<span class="fu">as.character</span>(params<span class="sc">$</span>currentYear)]]<span class="sc">$</span>locations <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(.,<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollY =</span> <span class="st">"300px"</span>), <span class="at">fillContainer =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-dba85141a1572c5d6d15" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-dba85141a1572c5d6d15">{"x":{"filter":"none","vertical":false,"fillContainer":true,"data":[["1","2","3","4","5","6","7","8","9","10"],[202303,202303,202303,202303,202303,202303,202303,202303,202303,202303],[176742,176742,176742,176742,176742,176742,176742,176742,176742,176742],[1074014,1074015,1074016,1074017,1074018,1074019,1074020,1074021,1074022,1074023],[1,1,1,1,1,1,1,1,1,1],[2.07,1.49,1.67,0.45,2.19,0,3.41,0.89,0.5600000000000001,0.5600000000000001],["N","SSW","W","ENE","SSW","N","SSW","NW","W","E"],["ABERNATHY ARPT","PROSPECT","NASHVILLE","GOODLETTSVILLE","MILLERSVILLE","GOODLETTSVILLE","CORNERSVILLE","JEFFERSON","IVY BLUFF","MONTEREY"],[35.18,35.01,36.17,36.322,36.3394,36.32,35.3231,35.99,35.67,36.15],[-87.05,-87.01000000000001,-86.81,-86.7123,-86.70999999999999,-86.72,-86.86879999999999,-86.48,-86.06,-85.26000000000001],[3510800,35600,3610200,3619320,3620364,3619200,3519386,3559400,3540200,369000],[873000,87600,8648600,8642738,8642600,8643200,8652128,8628800,863600,8515600]],"container":"<table class=\"display fill-container\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>yearmonth<\/th>\n      <th>episode_id<\/th>\n      <th>event_id<\/th>\n      <th>location_index<\/th>\n      <th>range<\/th>\n      <th>azimuth<\/th>\n      <th>location<\/th>\n      <th>latitude<\/th>\n      <th>longitude<\/th>\n      <th>lat2<\/th>\n      <th>lon2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollY":"300px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,8,9,10,11]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"yearmonth","targets":1},{"name":"episode_id","targets":2},{"name":"event_id","targets":3},{"name":"location_index","targets":4},{"name":"range","targets":5},{"name":"azimuth","targets":6},{"name":"location","targets":7},{"name":"latitude","targets":8},{"name":"longitude","targets":9},{"name":"lat2","targets":10},{"name":"lon2","targets":11}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="fatalities" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="fatalities"><span class="header-section-number">1.2.3</span> Fatalities</h3>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data_list[[<span class="fu">as.character</span>(params<span class="sc">$</span>currentYear)]]<span class="sc">$</span>fatalities <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(.,<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollY =</span> <span class="st">"300px"</span>), <span class="at">fillContainer =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2681b1d94d390caba02c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2681b1d94d390caba02c">{"x":{"filter":"none","vertical":false,"fillContainer":true,"data":[["1","2","3","4","5","6","7","8","9","10"],[202307,202307,202307,202307,202307,202307,202307,202307,202307,202307],[29,29,27,28,28,24,1,1,4,19],[0,0,0,0,0,0,0,0,0,0],[49378,49359,49455,50209,50230,49305,49307,49347,49348,49358],[1108090,1108167,1109732,1128929,1131465,1104617,1106092,1106242,1106313,1107915],["D","D","D","D","D","D","D","D","D","D"],["07/29/2023 00:00:00","07/29/2023 00:00:00","07/27/2023 00:00:00","07/28/2023 00:00:00","07/28/2023 00:00:00","07/24/2023 00:00:00","07/01/2023 00:00:00","07/01/2023 00:00:00","07/04/2023 00:00:00","07/19/2023 00:00:00"],[75,44,53,52,7,48,58,42,null,1],["M","M","F","F","M","F","M","M","","F"],["Permanent Home","Permanent Home","Permanent Home","Permanent Home","In Water","In Water","In Water","In Water","In Water","Vehicle/Towed Trailer"],[202307,202307,202307,202307,202307,202307,202307,202307,202307,202307]],"container":"<table class=\"display fill-container\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>fat_yearmonth<\/th>\n      <th>fat_day<\/th>\n      <th>fat_time<\/th>\n      <th>fatality_id<\/th>\n      <th>event_id<\/th>\n      <th>fatality_type<\/th>\n      <th>fatality_date<\/th>\n      <th>fatality_age<\/th>\n      <th>fatality_sex<\/th>\n      <th>fatality_location<\/th>\n      <th>event_yearmonth<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollY":"300px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,8,11]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"fat_yearmonth","targets":1},{"name":"fat_day","targets":2},{"name":"fat_time","targets":3},{"name":"fatality_id","targets":4},{"name":"event_id","targets":5},{"name":"fatality_type","targets":6},{"name":"fatality_date","targets":7},{"name":"fatality_age","targets":8},{"name":"fatality_sex","targets":9},{"name":"fatality_location","targets":10},{"name":"event_yearmonth","targets":11}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="recency-of-data" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="recency-of-data"><span class="header-section-number">1.3</span> Recency of Data</h2>
<p>What is the most recent data available in “details” for <code>params$currentYear</code>?</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>data_list[[<span class="fu">as.character</span>(params<span class="sc">$</span>currentYear)]]<span class="sc">$</span>details <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">arrange_date =</span> <span class="fu">strptime</span>(end_date_time, <span class="at">format =</span> <span class="st">"%d-%b-%y %H:%M:%S"</span>) <span class="sc">%&gt;%</span> <span class="fu">as_datetime</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(arrange_date)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span>end_date_time <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "31-DEC-23 23:59:00"</code></pre>
</div>
</div>
</section>
<section id="create-combined-datasets" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="create-combined-datasets"><span class="header-section-number">1.4</span> Create Combined Datasets</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(data_list))) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  data_details <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_details, data_list[[i]]<span class="sc">$</span>details)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>data_locations <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(data_list))) {</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  data_locations <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_locations, data_list[[i]]<span class="sc">$</span>locations)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>data_fatalities <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(data_list))) {</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  data_fatalities <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_fatalities, data_list[[i]]<span class="sc">$</span>fatalities)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co"># since we will mostly work with data_details, let's save this data set</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="fu">paste0</span>(time, <span class="st">"_data_details.RDS"</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(data_details, <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">"../data/stormData"</span>, fileName))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tidy-data" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Tidy Data</h1>
<section id="simple-tidying" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="simple-tidying"><span class="header-section-number">2.1</span> Simple Tidying</h2>
<p>We will mainly work with <code>data_details</code>. Let’s tidy up this data (convert some integers to characters, some characters to integers, and some characters to date-time format).</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load most recent data_details</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="st">"data_details.RDS"</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pathName <span class="ot">&lt;-</span> <span class="st">"../data/stormData"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>filePath <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(<span class="at">path =</span> pathName, <span class="at">regexp =</span> <span class="fu">paste0</span>(fileName, <span class="st">"$"</span>)) <span class="sc">%&gt;%</span> <span class="fu">last</span>()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filePath)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># convert some integers to characters so that they are not mistakenly treated</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># as integers</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>toChar <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"episode_id"</span>, <span class="st">"event_id"</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"state_fips"</span>, <span class="st">"cz_fips"</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"category"</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tor_other_cz_fips"</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> data_details <span class="sc">%&gt;%</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(toChar), as.character))</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(toChar)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># for damage values, we need to convert strings like</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># "3.12M" and "117.00K" to integer values. We define a function to do so:</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>convert_to_integer <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  multiplier <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"K"</span> <span class="ot">=</span> <span class="dv">1000</span>, <span class="st">"M"</span> <span class="ot">=</span> <span class="dv">1000000</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  numeric_part <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"[^0-9.]"</span>, <span class="st">""</span>, x))</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  multiplier_part <span class="ot">&lt;-</span> <span class="fu">substr</span>(x, <span class="fu">nchar</span>(x), <span class="fu">nchar</span>(x))</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  multiplier_value <span class="ot">&lt;-</span> multiplier[multiplier_part]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.integer</span>(numeric_part <span class="sc">*</span> multiplier_value))</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co"># apply function to "damage" variables</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> data_details <span class="sc">%&gt;%</span> </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"damage"</span>), convert_to_integer))</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(convert_to_integer)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># convert some character columns to date-time format</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> data_details <span class="sc">%&gt;%</span> </span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"date_time"</span>), dmy_hms))</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co"># store month_name as factor with the correct order of months as levels</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> data_details <span class="sc">%&gt;%</span> </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_name =</span> <span class="fu">factor</span>(month_name, <span class="at">levels =</span> month.name))</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co"># state_fips need to be two digits long. If the first digit was zero, this leading</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="co"># zero was removed during the read in process of the data. This is corrected</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="co"># using str_pad. Similarly, cz_fips needs to be three digits long.</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>data_details <span class="ot">&lt;-</span> data_details <span class="sc">%&gt;%</span> </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state_fips =</span> <span class="fu">str_pad</span>(state_fips, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">side =</span> <span class="st">"left"</span>, <span class="at">pad =</span> <span class="st">"0"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cz_fips =</span> <span class="fu">str_pad</span>(cz_fips, <span class="at">width =</span> <span class="dv">3</span>, <span class="at">side =</span> <span class="st">"left"</span>, <span class="at">pad =</span> <span class="st">"0"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fips-tidying" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="fips-tidying"><span class="header-section-number">2.2</span> FIPS Tidying</h2>
<p>For various forms of analyses, we will need the Federal Information Processing System (FIPS) Codes for States and Counties. For instance, we will need this information to associate specific extreme weather events with certain geographical regions (mostly Counties). The package <a href="https://github.com/pdil/usmap">usmap</a>, which we will use to display geographical distributions of extreme weather events, works with county FIPS. Therefore, we need to tidy up our data to show events that conform to such FIPS data. The FIPS information is stored in two separate variables in the data set: <code>state_fips</code> and <code>cz_fips</code>.</p>
<p><strong>Note that the storm event database assigns FIPS not only to County/Parish (<code>cz_type == "C"</code>), but also NWS Public Forecast Zone and Marine Zones (<code>cz_type == "Z"</code>).</strong></p>
<p>Thus, the meaning of variable <code>cz_fips</code> depends on <code>cz_type</code>. Therefore, we first need to convert Z-type FIPS to C-type FIPS. There is a <a href="https://www.nws.noaa.gov/directives/sym/pd01005007curr.pdf">mapping</a> of Forecast Zones onto County FIPS we can use for this. In the following code block, we</p>
<ol type="1">
<li><p>create a data set <code>mappingData</code> with all the information to map NWS Forecast Zones to County FIPS and</p></li>
<li><p>use this mapping information to create a variable <code>county_fips</code> representing the County FIPS and</p></li>
<li><p>ultimately create a variable <code>state_county_fips</code> representing the full FIPS identifying each County in each State.</p></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>FUNConvertFips <span class="ot">&lt;-</span> <span class="cf">function</span>(myData) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define vector of urls to .txt files containing the mapping information</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  urlsToFiles <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_AR.txt"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_CR.txt"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_ER.txt"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_PR.txt"</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_SR.txt"</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.weather.gov/source/pimar/PubRep/PUB_WR.txt"</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define the variable names of each column in these files</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  varNames <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state_abr"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id_zone"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location_descr"</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"county"</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fips"</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"city"</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state_city_abr"</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define a function to read in the files</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  FUNReadFiles <span class="ot">&lt;-</span> <span class="cf">function</span>(myURL) {</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    dataOut <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> myURL,</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">sep =</span> <span class="st">"|"</span>,</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">header =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">quote =</span> <span class="st">""</span>,</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">colClasses =</span> <span class="st">"character"</span>,</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">FALSE</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(dataOut) <span class="ot">&lt;-</span> varNames</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(dataOut)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "loop" over this function and continuously combine read in data into one data frame</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  mappingData <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">ldply</span>(urlsToFiles, FUNReadFiles) <span class="sc">%&gt;%</span> </span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create data set that maps state abbreviations to full state names</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  mapping_states_abbr <span class="ot">&lt;-</span> usmap<span class="sc">::</span><span class="fu">fips_info</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(abbr, full) <span class="sc">%&gt;%</span> </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">toupper</span>(full)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>full)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine mappingData with mapping_states_abbr</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>  mappingData <span class="ot">&lt;-</span> mappingData <span class="sc">%&gt;%</span> </span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="at">y =</span> mapping_states_abbr, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state_abr"</span> <span class="ot">=</span> <span class="st">"abbr"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(state, <span class="at">.after =</span> state_abr) <span class="sc">%&gt;%</span> </span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cz_fips =</span> id_zone) <span class="sc">%&gt;%</span> </span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(cz_fips, <span class="at">.after =</span> id_zone) <span class="sc">%&gt;%</span> </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">county_fips =</span> <span class="fu">str_extract</span>(fips, <span class="st">".{3}$"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(county_fips, <span class="at">.after =</span> fips)</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># subset myData to myData_czTypeC and myData_czTypeZ</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  myData_czTypeC <span class="ot">&lt;-</span> myData <span class="sc">%&gt;%</span> </span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(cz_type <span class="sc">==</span> <span class="st">"C"</span>)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  myData_czTypeZ <span class="ot">&lt;-</span> myData <span class="sc">%&gt;%</span> </span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(cz_type <span class="sc">==</span> <span class="st">"Z"</span>)</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define county_fips in myData_czTypeC</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  myData_czTypeC <span class="ot">&lt;-</span> myData_czTypeC <span class="sc">%&gt;%</span> </span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">county_fips =</span> cz_fips)</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define county_fips in myData_czTypeZ</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first, create a temporary dataset</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> myData_czTypeZ,</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> mappingData <span class="sc">%&gt;%</span> </span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(state, cz_fips, county_fips),</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"cz_fips"</span>),</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-many"</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># then, create a list with meta information for myData_czTypeZ</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  myData_czTypeZ_meta <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">county_fips_isNA =</span> tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)),</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_id_isDoublicated =</span> tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">duplicated</span>(event_id)),</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">myData_czTypeZ_raw =</span> tmp,</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">myData_czTypeZ_county_fips_isNA.removed =</span> tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_fips))</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define myData_czTypeZ</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note that we only retain events whose county_fips is not NA! To see where</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these NAs come from, see myData_czTypeZ_meta$county_fips_isNA</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>  myData_czTypeZ <span class="ot">&lt;-</span> myData_czTypeZ_meta<span class="sc">$</span>myData_czTypeZ_county_fips_isNA.removed</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># join myData_czTypeC and myData_czTypeZ</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">names</span>(myData_czTypeC) <span class="sc">==</span> <span class="fu">names</span>(myData_czTypeZ))) {</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    myData_fips <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>      myData_czTypeC,</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>      myData_czTypeZ</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"all(names(myData_czTypeC) == names(myData_czTypeZ)) != TRUE"</span>)</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create variable state_county_fips representing the full and correct fips for each county</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>  myData_fips <span class="ot">&lt;-</span> myData_fips <span class="sc">%&gt;%</span> </span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state_county_fips =</span> <span class="fu">str_c</span>(state_fips, county_fips))</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">myData_fips =</span> myData_fips,</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">myData_czTypeZ_meta =</span> myData_czTypeZ_meta</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a><span class="co"># call function</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>out_FUNConvertFips <span class="ot">&lt;-</span> <span class="fu">FUNConvertFips</span>(data_details)</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a><span class="co"># define data_details_fips</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> out_FUNConvertFips<span class="sc">$</span>myData_fips</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a><span class="co"># save data_details_fips</span></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="fu">paste0</span>(time, <span class="st">"_data_details_fips_raw.RDS"</span>)</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(data_details_fips, <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">"../data/stormData"</span>, fileName))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After these changes, some challenges remain, which become obvious, if we try to match the FIPS provided in the data set with current FIPS available in <code>usmap</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load most recent data_details_fips</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="st">"data_details_fips_raw.RDS"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>pathName <span class="ot">&lt;-</span> <span class="st">"../data/stormData"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>filePath <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(<span class="at">path =</span> pathName, <span class="at">regexp =</span> <span class="fu">paste0</span>(fileName, <span class="st">"$"</span>)) <span class="sc">%&gt;%</span> <span class="fu">last</span>()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filePath)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># capture the warning message produced if we apply usmap::fips_info to</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># all unique state_county_fips in data_details_fips</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>warning_message <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">fips_info</span>(<span class="at">fips =</span> <span class="fu">unique</span>(<span class="fu">as.character</span>(data_details_fips<span class="sc">$</span>state_county_fips)))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>}, <span class="at">warning =</span> <span class="cf">function</span>(w) {</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">conditionMessage</span>(w))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>unmatched_fips <span class="ot">&lt;-</span> <span class="fu">str_extract_all</span>(warning_message, <span class="st">"</span><span class="sc">\\</span><span class="st">b</span><span class="sc">\\</span><span class="st">d{5}</span><span class="sc">\\</span><span class="st">b"</span>)[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># create a tibble containing all unmatched fips</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>unmatched_fips <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">state_county_fips =</span> unmatched_fips,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">state_fips =</span> state_county_fips <span class="sc">%&gt;%</span> </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_extract</span>(<span class="st">"^.{2}"</span>),</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">county_fips =</span> state_county_fips <span class="sc">%&gt;%</span> </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_extract</span>(<span class="st">".{3}$"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state_county_fips)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co"># in which states do we find unmatched fips?</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>unmatched_fips_states <span class="ot">&lt;-</span> unmatched_fips <span class="sc">%&gt;%</span> </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(state_fips) <span class="sc">%&gt;%</span> </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> usmap<span class="sc">::</span><span class="fu">fips_info</span>(),</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span><span class="fu">c</span>(<span class="st">"state_fips"</span> <span class="ot">=</span> <span class="st">"fips"</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># # inspect the main land states that had unmatched fips</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co"># unmatched_fips_states_mainLand &lt;- unmatched_fips_states %&gt;% </span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(!is.na(abbr))</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_usmap(regions = "counties", include = unmatched_fips_states_mainLand$abbr[1], labels = TRUE)</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_usmap(regions = "counties", include = unmatched_fips_states_mainLand$abbr[2], labels = TRUE)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co"># unmatched_fips %&gt;%</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(state_fips == "02")</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="co"># data_details_fips %&gt;% </span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(state_fips %in% (unmatched_fips_states %&gt;% </span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="co">#            filter(is.na(abbr)) %&gt;% </span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="co">#            pull(state_fips))) %&gt;% </span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(state, cz_name) %&gt;% </span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="co">#   distinct(state)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(unmatched_fips)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-unmatchedFips" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-unmatchedFips-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: FIPS in data_details_fips that do not match with current FIPS as provided by <code>usmap</code>.
</figcaption>
<div aria-describedby="tbl-unmatchedFips-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-be524e9d34766fec829c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-be524e9d34766fec829c">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138"],["02017","02018","02019","02021","02023","02025","02026","02027","02028","02029","02101","02111","02121","02125","02131","02135","02141","02145","02152","02155","02161","02171","02181","02203","02210","02213","02214","02215","02216","02217","02218","02219","02221","02222","02223","02224","02225","02226","02227","02261","02318","02319","02325","02326","02327","09001","09003","09005","09007","09009","09011","09013","09015","96010","96020","96030","97002","97003","98002","98003","98006","99001","99003","99005","99007","99009","99011","99013","99015","99017","99019","99021","99023","99025","99027","99029","99031","99033","99035","99037","99039","99041","99043","99045","99047","99049","99051","99053","99054","99055","99057","99059","99061","99063","99065","99067","99069","99071","99073","99075","99077","99079","99081","99083","99085","99087","99089","99091","99095","99097","99099","99101","99103","99105","99107","99109","99111","99113","99115","99117","99119","99121","99123","99125","99127","99129","99131","99133","99135","99137","99139","99141","99143","99145","99147","99149","99151","99153"],["02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","02","09","09","09","09","09","09","09","09","96","96","96","97","97","98","98","98","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99","99"],["017","018","019","021","023","025","026","027","028","029","101","111","121","125","131","135","141","145","152","155","161","171","181","203","210","213","214","215","216","217","218","219","221","222","223","224","225","226","227","261","318","319","325","326","327","001","003","005","007","009","011","013","015","010","020","030","002","003","002","003","006","001","003","005","007","009","011","013","015","017","019","021","023","025","027","029","031","033","035","037","039","041","043","045","047","049","051","053","054","055","057","059","061","063","065","067","069","071","073","075","077","079","081","083","085","087","089","091","095","097","099","101","103","105","107","109","111","113","115","117","119","121","123","125","127","129","131","133","135","137","139","141","143","145","147","149","151","153"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>state_county_fips<\/th>\n      <th>state_fips<\/th>\n      <th>county_fips<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"state_county_fips","targets":1},{"name":"state_fips","targets":2},{"name":"county_fips","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(unmatched_fips_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-unmatchedFipsStates" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-unmatchedFipsStates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: States associated with the unmatched FIPS reported in <a href="#tbl-unmatchedFips" class="quarto-xref">Table&nbsp;1</a>.
</figcaption>
<div aria-describedby="tbl-unmatchedFipsStates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">state_fips</th>
<th style="text-align: left;">abbr</th>
<th style="text-align: left;">full</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">AK</td>
<td style="text-align: left;">Alaska</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">CT</td>
<td style="text-align: left;">Connecticut</td>
</tr>
<tr class="odd">
<td style="text-align: left;">96</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">97</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">98</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">99</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>What is the origin of these unmatched FIPS? First, as listed in <a href="#tbl-terretoriesOfUS" class="quarto-xref">Table&nbsp;3</a>, <code>state_fips</code> 96, 97, 98, 99 are assigned to the following states that are considered territories (and not states) of the US. We will exclude these territories in further analyses.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_fips <span class="sc">%in%</span> (unmatched_fips_states <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">filter</span>(<span class="fu">is.na</span>(abbr)) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pull</span>(state_fips))) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(state_fips, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_fips, state) <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-terretoriesOfUS" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-terretoriesOfUS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Terretories of the US in the <code>data_details_fips</code>
</figcaption>
<div aria-describedby="tbl-terretoriesOfUS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">state_fips</th>
<th style="text-align: left;">state</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">99</td>
<td style="text-align: left;">PUERTO RICO</td>
</tr>
<tr class="even">
<td style="text-align: left;">96</td>
<td style="text-align: left;">VIRGIN ISLANDS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">98</td>
<td style="text-align: left;">GUAM</td>
</tr>
<tr class="even">
<td style="text-align: left;">97</td>
<td style="text-align: left;">AMERICAN SAMOA</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Second, there are many unmatched FIPS in the state of Alaska (<a href="#tbl-unmatchedFipsAlaska" class="quarto-xref">Table&nbsp;4</a>). This is due to the fact that Alaska had substantial changes to counties and their boundaries over the years (see <a href="https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.2010.html#list-tab-957819518">here</a>). Consistent information on how to map old counties to new counties is not readily available. We will exclude Alaska from further analyses.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_county_fips <span class="sc">%in%</span> <span class="fu">filter</span>(unmatched_fips, state_fips <span class="sc">==</span> <span class="st">"02"</span>)<span class="sc">$</span>state_county_fips) <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_county_fips, state, cz_name) <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # are there unmatched FIPS for Alaska in the latest year data? - YES</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># data_details_fips %&gt;% </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(year == params$currentYear, state_fips == "02") %&gt;% </span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(state_county_fips %in% unmatched_fips$state_county_fips) %&gt;% </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(state_county_fips, state, cz_name)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-unmatchedFipsAlaska" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-unmatchedFipsAlaska-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Unmatched FIPS in the state of Alaska.
</figcaption>
<div aria-describedby="tbl-unmatchedFipsAlaska-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-dba85141a1572c5d6d15" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-dba85141a1572c5d6d15">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53"],["02125","02018","02216","02224","02214","02141","02223","02219","02222","02210","02203","02028","02217","02027","02213","02101","02025","02225","02135","02218","02017","02023","02111","02221","02145","02181","02121","02155","02152","02161","02029","02171","02019","02021","02026","02319","02325","02227","02131","02318","02215","02226","02327","02326","02261","02261","02261","02261","02261","02261","02261","02261","02261"],["ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA","ALASKA"],["WRN P.W. SND &amp; KENAI MTNS","TAIYA INLET","LOWER KOYUKUK MIDDLE YKN VLYS","UPR TANANA VLY FORTYMILE","YUKON DELTA","COPPER RIVER BASIN","DELTANA AND TANANA","UPPER KOYUKUK VALLEY","MIDDLE TANANA VALLEY","NRN &amp; INTR. SEWARD PENINSULA","CENTRAL BEAUFORT SEA COAST","KETCHIKAN CHANNELS","UPPER KOBUK AND NOATAK VLYS","CRAIG COASTAL","ST LAWRENCE IS. BERING STRAIT","ANCHORAGE MUNI TO BIRD CREEK","JUNEAU BOROUGH","DENALI","SERN P.W. SND","S. SLOPES OF ERN BROOKS RANGE","YAKUTAT COASTAL","SITKA COASTAL","MATANUSKA VALLEY","WRN TANANA VLY WRN YUKON VLY","SUSITNA VALLEY","ALASKA PENINSULA","KENAI PENINSULA","KUSKOKWIM DELTA","LOWER KUSKOKWIM VALLEY","BRISTOL BAY","MISTY FJORDS","KODIAK PENINSULA","HAINES BOROUGH","HOONAH CHANNELS","WRANGELL CHANNELS","HAINES BOROUGH","JUNEAU BOROUGH","UPPER KUSKOKWIM VALLEY","NERN P.W. SND","TAIYA INLET","LOWER YUKON VALLEY","NE. SLOPES OF THE ERN AK RNG","CRAIG COASTAL","WRANGELL CHANNELS","NE. SLOPES OF THE ERN AK RNG","NERN P.W. SND","UPR TANANA VLY FORTYMILE","SERN P.W. SND","WRN P.W. SND &amp; KENAI MTNS","COPPER RIVER BASIN","Northeast Slopes of the Eastern AK Range","Western Prince William Sound &amp; Kenai Mountains","Northeastern Prince William Sound"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>state_county_fips<\/th>\n      <th>state<\/th>\n      <th>cz_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"state_county_fips","targets":1},{"name":"state","targets":2},{"name":"cz_name","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<p>Third, there were substantial changes in the state of Connecticut: Originally, it consisted of 8 counties. After the changes, these counties were replaced with 9 new counties (for more information, see <a href="https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.2020.html#list-tab-957819518">here</a> and <a href="https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut">here</a>). The old counties map to the new counties according to <a href="#tbl-connecticutNewPlanningReagions-fineGrained" class="quarto-xref">Table&nbsp;5</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in xlsx file mapping old counties and FIPS to new counties and FIPS</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>connecticut_newPlanningRegions <span class="ot">&lt;-</span> openxlsx<span class="sc">::</span><span class="fu">read.xlsx</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlsxFile =</span> <span class="st">"https://www2.census.gov/geo/docs/reference/ct_change/ct_cou_to_cousub_crosswalk.xlsx"</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># rename variable names</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(connecticut_newPlanningRegions) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"state_fips"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"old_county_fips"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"old_county_name"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"new_county_fips"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"new_county_name"</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co"># select distinct combinations of our variables of interest</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>connecticut_newPlanningRegions <span class="ot">&lt;-</span> connecticut_newPlanningRegions <span class="sc">%&gt;%</span> </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(state_fips, old_county_fips, new_county_fips, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># combine state and county fips</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>connecticut_newPlanningRegions <span class="ot">&lt;-</span> connecticut_newPlanningRegions <span class="sc">%&gt;%</span> </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state_county_fips_old =</span> <span class="fu">paste0</span>(state_fips, old_county_fips),</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">state_county_fips_new =</span> <span class="fu">paste0</span>(state_fips, new_county_fips))</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># display table</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(connecticut_newPlanningRegions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-connecticutNewPlanningReagions-fineGrained" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-connecticutNewPlanningReagions-fineGrained-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Connecticut exact mapping of old counties to new counties.
</figcaption>
<div aria-describedby="tbl-connecticutNewPlanningReagions-fineGrained-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2681b1d94d390caba02c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2681b1d94d390caba02c">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28"],["09","09","09","09","09","09","09","09","09","09","09","09","09","09","09","09","09","09","09","GLOSSARY","STATEFP = State FIPS Code / ANSI INCITS 38 Code","COUNTYFP = County FIPS Code / ANSI INCITS 31 Code","COUSUBFP = County Subdivision FIPS Code","LSAD = Legal Statistical Area Descriptor Code","COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS Code","COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 Code","FUNCSTAT = Functional Status","CLASSFP = FIPS Class Code"],["001","001","001","003","003","003","005","005","005","007","009","009","011","011","011","013","013","015","015",null,null,null,null,null,null,null,null,null],["Fairfield County","Fairfield County","Fairfield County","Hartford County","Hartford County","Hartford County","Litchfield County","Litchfield County","Litchfield County","Middlesex County","New Haven County","New Haven County","New London County","New London County","New London County","Tolland County","Tolland County","Windham County","Windham County",null,null,null,null,null,null,null,null,null],["120","140","190","110","140","160","140","160","190","130","140","170","130","150","180","110","150","150","180",null,null,null,null,null,null,null,null,null],["Greater Bridgeport Planning Region","Naugatuck Valley Planning Region","Western Connecticut Planning Region","Capitol Planning Region","Naugatuck Valley Planning Region","Northwest Hills Planning Region","Naugatuck Valley Planning Region","Northwest Hills Planning Region","Western Connecticut Planning Region","Lower Connecticut River Valley Planning Region","Naugatuck Valley Planning Region","South Central Connecticut Planning Region","Lower Connecticut River Valley Planning Region","Northeastern Connecticut Planning Region","Southeastern Connecticut Planning Region","Capitol Planning Region","Northeastern Connecticut Planning Region","Northeastern Connecticut Planning Region","Southeastern Connecticut Planning Region",null,null,null,null,null,null,null,null,null],["09001","09001","09001","09003","09003","09003","09005","09005","09005","09007","09009","09009","09011","09011","09011","09013","09013","09015","09015","GLOSSARYNA","STATEFP = State FIPS Code / ANSI INCITS 38 CodeNA","COUNTYFP = County FIPS Code / ANSI INCITS 31 CodeNA","COUSUBFP = County Subdivision FIPS CodeNA","LSAD = Legal Statistical Area Descriptor CodeNA","COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS CodeNA","COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 CodeNA","FUNCSTAT = Functional StatusNA","CLASSFP = FIPS Class CodeNA"],["09120","09140","09190","09110","09140","09160","09140","09160","09190","09130","09140","09170","09130","09150","09180","09110","09150","09150","09180","GLOSSARYNA","STATEFP = State FIPS Code / ANSI INCITS 38 CodeNA","COUNTYFP = County FIPS Code / ANSI INCITS 31 CodeNA","COUSUBFP = County Subdivision FIPS CodeNA","LSAD = Legal Statistical Area Descriptor CodeNA","COUSUB_GEOID = Nationally Unique Geographic Identifier, State FIPS Code + County FIPS Code + County Subdivision FIPS CodeNA","COUSUBNS = County Subdivision National Standard (NS) Code / ANSI INCITS 446 CodeNA","FUNCSTAT = Functional StatusNA","CLASSFP = FIPS Class CodeNA"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>state_fips<\/th>\n      <th>old_county_fips<\/th>\n      <th>old_county_name<\/th>\n      <th>new_county_fips<\/th>\n      <th>new_county_name<\/th>\n      <th>state_county_fips_old<\/th>\n      <th>state_county_fips_new<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"state_fips","targets":1},{"name":"old_county_fips","targets":2},{"name":"old_county_name","targets":3},{"name":"new_county_fips","targets":4},{"name":"new_county_name","targets":5},{"name":"state_county_fips_old","targets":6},{"name":"state_county_fips_new","targets":7}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<p>However, this mapping is too fine grained for our purposes. A better mapping can be achieved following <a href="#fig-connecticutOldToNewCountiesMapping" class="quarto-xref">Figure&nbsp;1</a>, which results in the following mapping summarized in <a href="#tbl-connecticutNewPlanningReagions-lessFineGrained" class="quarto-xref">Table&nbsp;6</a>.</p>
<div id="fig-connecticutOldToNewCountiesMapping" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-connecticutOldToNewCountiesMapping-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://img.federalregister.gov/EN06JN22.001/EN06JN22.001_original_size.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-connecticutOldToNewCountiesMapping-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Mapping of old to new counties in Connecticut.
</figcaption>
</figure>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>old_fips <span class="ot">&lt;-</span> unmatched_fips <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_fips <span class="sc">==</span> <span class="st">"09"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state_county_fips) <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(state_county_fips)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>old_counties <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Fairfield"</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Harford"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Litchfield"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Middlesex"</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New Haven"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New London"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tolland"</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Windham"</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>old <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">old_county =</span> old_counties,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">old_fips =</span> old_fips</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>new_counties <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Greater Bridgeport Planning Region"</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Western Connecticut Planning Region"</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Capitol Planning Region"</span>,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Northwest Hills Planning Region"</span>,</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Lower Connecticut River Valley Planning Region"</span>,</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naugatuck Valley Planning Region"</span>,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"South Central Connecticut Planning Region"</span>,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Southeastern Connecticut Planning Region"</span>,</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Northeastern Connecticut Planning Region"</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>new_fips <span class="ot">&lt;-</span> usmap<span class="sc">::</span><span class="fu">fips</span>(<span class="at">state =</span> <span class="st">"CT"</span>, <span class="at">county =</span> new_counties)</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>new <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_county =</span> new_counties,</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_fips =</span> new_fips</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>old_counties_to_new_counties <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">old_county =</span> <span class="fu">c</span>(</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fairfield"</span>,</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fairfield"</span>,</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Harford"</span>,</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tolland"</span>,</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Litchfield"</span>,</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Middlesex"</span>,</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"New Haven"</span>,</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"New Haven"</span>,</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"New London"</span>,</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Windham"</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_county =</span> <span class="fu">c</span>(</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Greater Bridgeport Planning Region"</span>,</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Western Connecticut Planning Region"</span>,</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Capitol Planning Region"</span>,</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Capitol Planning Region"</span>,</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Northwest Hills Planning Region"</span>,</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lower Connecticut River Valley Planning Region"</span>,</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naugatuck Valley Planning Region"</span>,</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"South Central Connecticut Planning Region"</span>,</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Southeastern Connecticut Planning Region"</span>,</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Northeastern Connecticut Planning Region"</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>connecticut_newPlanningRegions <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> old_counties_to_new_counties,</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> old,</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"old_county"</span></span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> new,</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"new_county"</span></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a><span class="co"># do some renamign and add new_county_fips</span></span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>connecticut_newPlanningRegions <span class="ot">&lt;-</span> connecticut_newPlanningRegions <span class="sc">%&gt;%</span> </span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">old_state_county_fips =</span> old_fips,</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_state_county_fips =</span> new_fips</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_county_fips =</span> new_state_county_fips <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">".{3}$"</span>))</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(connecticut_newPlanningRegions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-connecticutNewPlanningReagions-lessFineGrained" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-connecticutNewPlanningReagions-lessFineGrained-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Connecticut mapping of old counties to new counties.
</figcaption>
<div aria-describedby="tbl-connecticutNewPlanningReagions-lessFineGrained-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-e8bfab676c78a777a7dc" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-e8bfab676c78a777a7dc">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["Fairfield","Fairfield","Harford","Tolland","Litchfield","Middlesex","New Haven","New Haven","New London","Windham"],["Greater Bridgeport Planning Region","Western Connecticut Planning Region","Capitol Planning Region","Capitol Planning Region","Northwest Hills Planning Region","Lower Connecticut River Valley Planning Region","Naugatuck Valley Planning Region","South Central Connecticut Planning Region","Southeastern Connecticut Planning Region","Northeastern Connecticut Planning Region"],["09001","09001","09003","09013","09005","09007","09009","09009","09011","09015"],["09120","09190","09110","09110","09160","09130","09140","09170","09180","09150"],["120","190","110","110","160","130","140","170","180","150"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>old_county<\/th>\n      <th>new_county<\/th>\n      <th>old_state_county_fips<\/th>\n      <th>new_state_county_fips<\/th>\n      <th>new_county_fips<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"old_county","targets":1},{"name":"new_county","targets":2},{"name":"old_state_county_fips","targets":3},{"name":"new_state_county_fips","targets":4},{"name":"new_county_fips","targets":5}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<p>Now we apply the changes mentioned above to <code>data_details_fips</code>:</p>
<ol type="1">
<li><p>remove US territories from data set</p></li>
<li><p>remove state of Alaska from data set</p></li>
<li><p>apply new county names and FIPS to the state of Connecticut</p></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we apply the changes outlined in the main text in slightly changed order</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># first, we apply the new county names and FIPS to the state of Connecticut</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We check whether all state_county_fips for Connecticut are recorded using the old</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># fips.</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_fips <span class="sc">==</span> <span class="st">"09"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>state_county_fips <span class="sc">%in%</span> unmatched_fips<span class="sc">$</span>state_county_fips)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">nrow</span>(tmp)) {</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"All state_county_fips are recorded following the old FIPS codes."</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"There are state_county_fips that are recorded following the new FIPS codes!"</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(tmp)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data set without Connecticut entries that follow the old FIPS codes</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>data_details_fips_withoutCT <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(state_fips <span class="sc">==</span> <span class="st">"09"</span> <span class="sc">&amp;</span> (state_county_fips <span class="sc">%in%</span> unmatched_fips<span class="sc">$</span>state_county_fips)))</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data set containing only Connecticut entries that follow the old FIPS codes</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>data_details_fips_CT <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_fips <span class="sc">==</span> <span class="st">"09"</span> <span class="sc">&amp;</span> (state_county_fips <span class="sc">%in%</span> unmatched_fips<span class="sc">$</span>state_county_fips))</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># mutate county_fips and state_county_fips so that they represent the new county_fips</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># and state_county_fips. Note that this will inflate the previously data_details_fips_CT</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># because there is a one-to-many relationsipt between old and new fips.</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>data_details_fips_CT <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> data_details_fips_CT,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> connecticut_newPlanningRegions <span class="sc">%&gt;%</span> </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(old_state_county_fips, new_state_county_fips, new_county_fips),</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state_county_fips"</span> <span class="ot">=</span> <span class="st">"old_state_county_fips"</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">county_fips =</span> new_county_fips,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_county_fips =</span> new_state_county_fips</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"new_"</span>))</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="co"># check whether the datasets without and with Connecticut have the same structure before</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co"># joning them again.</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">names</span>(data_details_fips_withoutCT) <span class="sc">==</span> <span class="fu">names</span>(data_details_fips_CT))) {</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"all(names(data_details_fips_withoutCT) == names(data_details_fips_CT)) == TRUE"</span>)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  data_details_fips <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    data_details_fips_withoutCT,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    data_details_fips_CT</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"The names of data_details_fips_withoutCT and data_details_fips_CT do not matach!"</span>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co"># then, we remove the US territories from the data set</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>state_fips <span class="sc">%in%</span> (unmatched_fips_states <span class="sc">%&gt;%</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">filter</span>(<span class="fu">is.na</span>(abbr)) <span class="sc">%&gt;%</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">pull</span>(state_fips)))</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, we remove the state of Alaska (FIPS = 02) from the data set, but we save</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co"># a data set still containing Alaska just in case...</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>data_details_fips_withAK <span class="ot">&lt;-</span> data_details_fips</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state_fips <span class="sc">!=</span> <span class="st">"02"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we rearrange some variables in <code>data_details_fips</code> and save them for later use. We also store <code>state_fips</code>, <code>state_county_fips</code> and <code>event_type</code> as factors. This becomes handy for accurately counting number of events by groups later on.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange order of variables in the data set</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    begin_yearmonth,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    episode_id, event_id,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    state, state_county_fips,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    event_type,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"damage"</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"injuries"</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"death"</span>),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">everything</span>()</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(begin_yearmonth, episode_id, event_id, state_county_fips)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># store state_county_fips and event_type as factor</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>data_details_fips <span class="ot">&lt;-</span> data_details_fips <span class="sc">%&gt;%</span> </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_fips =</span> <span class="fu">factor</span>(state_fips, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(.<span class="sc">$</span>state_fips))),</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_county_fips =</span> <span class="fu">factor</span>(state_county_fips, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(.<span class="sc">$</span>state_county_fips))),</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_type =</span> <span class="fu">factor</span>(event_type, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(.<span class="sc">$</span>event_type)))</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co"># save data_details_fips</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>fileName <span class="ot">&lt;-</span> <span class="fu">paste0</span>(time, <span class="st">"_data_details_fips.RDS"</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(data_details_fips, <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">"../data/stormData"</span>, fileName))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>